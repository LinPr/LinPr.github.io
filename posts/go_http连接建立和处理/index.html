<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Go_Http连接建立和处理 | Mr.LinPr Hugo Site</title>
<meta name=keywords content><meta name=description content="http 连接建立和处理 接收 http 请求并执行的过程 go func() { if err := s.ListenAndServe(); err != nil && err != http.ErrServerClosed { log.Fatalf(&#34;s.ListenAndServe err: %v&#34;, err) } }() 前面提到， 在路由引初始化完成后，注册对应的路由和 handler，接下来在 main 函数中 http.Server 就会监听指定的端口，我们来看下http.Server 是如何接收请求并执行对应的处理函数的
httpServer 会调用 Serve(l net.Listener 函数，这个函数主要做了以下几件事情
在一个循环里面不断监听套接字是否有链接请求上来，如果有的话，创建一个新的连接对象 这个连接对象中有，有两个成员，一个是套接字对象（实现了conn接口），一个是指向service对象的指针 最后一行，通过启动一个新的协程来处理连接事务，并对外提供服务 func (srv *Server) newConn(rwc net.Conn) *conn { c := &amp;conn{ server: srv, rwc: rwc, } if debugServerConnections { c.rwc = newLoggingConn(&#34;server&#34;, c.rwc) } return c } func (srv *Server) Serve(l net."><meta name=author content="Me"><link rel=canonical href=https://LinPr.github.io/posts/go_http%E8%BF%9E%E6%8E%A5%E5%BB%BA%E7%AB%8B%E5%92%8C%E5%A4%84%E7%90%86/><meta name=google-site-verification content="XYZabc"><meta name=yandex-verification content="XYZabc"><meta name=msvalidate.01 content="XYZabc"><link crossorigin=anonymous href=/assets/css/stylesheet.b609c58d5c11bb90b1a54e04005d74ad1ddf22165eb79f5533967e57df9c3b50.css integrity="sha256-tgnFjVwRu5CxpU4EAF10rR3fIhZet59VM5Z+V9+cO1A=" rel="preload stylesheet" as=style><link rel=icon href=https://LinPr.github.io/%3Clink%20/%20abs%20url%3E><link rel=icon type=image/png sizes=16x16 href=https://LinPr.github.io/%3Clink%20/%20abs%20url%3E><link rel=icon type=image/png sizes=32x32 href=https://LinPr.github.io/%3Clink%20/%20abs%20url%3E><link rel=apple-touch-icon href=https://LinPr.github.io/%3Clink%20/%20abs%20url%3E><link rel=mask-icon href=https://LinPr.github.io/%3Clink%20/%20abs%20url%3E><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><script>var doNotTrack=!1;doNotTrack||(function(e,t,n,s,o,i,a){e.GoogleAnalyticsObject=o,e[o]=e[o]||function(){(e[o].q=e[o].q||[]).push(arguments)},e[o].l=1*new Date,i=t.createElement(n),a=t.getElementsByTagName(n)[0],i.async=1,i.src=s,a.parentNode.insertBefore(i,a)}(window,document,"script","https://www.google-analytics.com/analytics.js","ga"),ga("create","UA-123-45","auto"),ga("send","pageview"))</script><meta property="og:title" content="Go_Http连接建立和处理"><meta property="og:description" content="http 连接建立和处理 接收 http 请求并执行的过程 go func() { if err := s.ListenAndServe(); err != nil && err != http.ErrServerClosed { log.Fatalf(&#34;s.ListenAndServe err: %v&#34;, err) } }() 前面提到， 在路由引初始化完成后，注册对应的路由和 handler，接下来在 main 函数中 http.Server 就会监听指定的端口，我们来看下http.Server 是如何接收请求并执行对应的处理函数的
httpServer 会调用 Serve(l net.Listener 函数，这个函数主要做了以下几件事情
在一个循环里面不断监听套接字是否有链接请求上来，如果有的话，创建一个新的连接对象 这个连接对象中有，有两个成员，一个是套接字对象（实现了conn接口），一个是指向service对象的指针 最后一行，通过启动一个新的协程来处理连接事务，并对外提供服务 func (srv *Server) newConn(rwc net.Conn) *conn { c := &amp;conn{ server: srv, rwc: rwc, } if debugServerConnections { c.rwc = newLoggingConn(&#34;server&#34;, c.rwc) } return c } func (srv *Server) Serve(l net."><meta property="og:type" content="article"><meta property="og:url" content="https://LinPr.github.io/posts/go_http%E8%BF%9E%E6%8E%A5%E5%BB%BA%E7%AB%8B%E5%92%8C%E5%A4%84%E7%90%86/"><meta property="og:image" content="https://LinPr.github.io/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E"><meta property="article:section" content="posts"><meta property="article:published_time" content="2024-02-09T12:15:13+08:00"><meta property="article:modified_time" content="2024-02-09T12:15:13+08:00"><meta property="og:site_name" content="ExampleSite"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://LinPr.github.io/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E"><meta name=twitter:title content="Go_Http连接建立和处理"><meta name=twitter:description content="http 连接建立和处理 接收 http 请求并执行的过程 go func() { if err := s.ListenAndServe(); err != nil && err != http.ErrServerClosed { log.Fatalf(&#34;s.ListenAndServe err: %v&#34;, err) } }() 前面提到， 在路由引初始化完成后，注册对应的路由和 handler，接下来在 main 函数中 http.Server 就会监听指定的端口，我们来看下http.Server 是如何接收请求并执行对应的处理函数的
httpServer 会调用 Serve(l net.Listener 函数，这个函数主要做了以下几件事情
在一个循环里面不断监听套接字是否有链接请求上来，如果有的话，创建一个新的连接对象 这个连接对象中有，有两个成员，一个是套接字对象（实现了conn接口），一个是指向service对象的指针 最后一行，通过启动一个新的协程来处理连接事务，并对外提供服务 func (srv *Server) newConn(rwc net.Conn) *conn { c := &amp;conn{ server: srv, rwc: rwc, } if debugServerConnections { c.rwc = newLoggingConn(&#34;server&#34;, c.rwc) } return c } func (srv *Server) Serve(l net."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://LinPr.github.io/posts/"},{"@type":"ListItem","position":2,"name":"Go_Http连接建立和处理","item":"https://LinPr.github.io/posts/go_http%E8%BF%9E%E6%8E%A5%E5%BB%BA%E7%AB%8B%E5%92%8C%E5%A4%84%E7%90%86/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Go_Http连接建立和处理","name":"Go_Http连接建立和处理","description":"http 连接建立和处理 接收 http 请求并执行的过程 go func() { if err := s.ListenAndServe(); err != nil \u0026amp;\u0026amp; err != http.ErrServerClosed { log.Fatalf(\u0026#34;s.ListenAndServe err: %v\u0026#34;, err) } }() 前面提到， 在路由引初始化完成后，注册对应的路由和 handler，接下来在 main 函数中 http.Server 就会监听指定的端口，我们来看下http.Server 是如何接收请求并执行对应的处理函数的\nhttpServer 会调用 Serve(l net.Listener 函数，这个函数主要做了以下几件事情\n在一个循环里面不断监听套接字是否有链接请求上来，如果有的话，创建一个新的连接对象 这个连接对象中有，有两个成员，一个是套接字对象（实现了conn接口），一个是指向service对象的指针 最后一行，通过启动一个新的协程来处理连接事务，并对外提供服务 func (srv *Server) newConn(rwc net.Conn) *conn { c := \u0026amp;conn{ server: srv, rwc: rwc, } if debugServerConnections { c.rwc = newLoggingConn(\u0026#34;server\u0026#34;, c.rwc) } return c } func (srv *Server) Serve(l net.","keywords":[],"articleBody":"http 连接建立和处理 接收 http 请求并执行的过程 go func() { if err := s.ListenAndServe(); err != nil \u0026\u0026 err != http.ErrServerClosed { log.Fatalf(\"s.ListenAndServe err: %v\", err) } }() 前面提到， 在路由引初始化完成后，注册对应的路由和 handler，接下来在 main 函数中 http.Server 就会监听指定的端口，我们来看下http.Server 是如何接收请求并执行对应的处理函数的\nhttpServer 会调用 Serve(l net.Listener 函数，这个函数主要做了以下几件事情\n在一个循环里面不断监听套接字是否有链接请求上来，如果有的话，创建一个新的连接对象 这个连接对象中有，有两个成员，一个是套接字对象（实现了conn接口），一个是指向service对象的指针 最后一行，通过启动一个新的协程来处理连接事务，并对外提供服务 func (srv *Server) newConn(rwc net.Conn) *conn { c := \u0026conn{ server: srv, rwc: rwc, } if debugServerConnections { c.rwc = newLoggingConn(\"server\", c.rwc) } return c } func (srv *Server) Serve(l net.Listener) error { if fn := testHookServerServe; fn != nil { fn(srv, l) // call hook with unwrapped listener } origListener := l l = \u0026onceCloseListener{Listener: l} defer l.Close() if err := srv.setupHTTP2_Serve(); err != nil { return err } if !srv.trackListener(\u0026l, true) { return ErrServerClosed } defer srv.trackListener(\u0026l, false) baseCtx := context.Background() if srv.BaseContext != nil { baseCtx = srv.BaseContext(origListener) if baseCtx == nil { panic(\"BaseContext returned a nil context\") } } var tempDelay time.Duration // how long to sleep on accept failure ctx := context.WithValue(baseCtx, ServerContextKey, srv) for { rw, err := l.Accept() if err != nil { if srv.shuttingDown() { return ErrServerClosed } if ne, ok := err.(net.Error); ok \u0026\u0026 ne.Temporary() { if tempDelay == 0 { tempDelay = 5 * time.Millisecond } else { tempDelay *= 2 } if max := 1 * time.Second; tempDelay \u003e max { tempDelay = max } srv.logf(\"http: Accept error: %v; retrying in %v\", err, tempDelay) time.Sleep(tempDelay) continue } return err } connCtx := ctx if cc := srv.ConnContext; cc != nil { connCtx = cc(connCtx, rw) if connCtx == nil { panic(\"ConnContext returned nil\") } } tempDelay = 0 c := srv.newConn(rw) c.setState(c.rwc, StateNew, runHooks) // before Serve can return go c.serve(connCtx) } } 继续往下看，我们看每个 accept 的连接是如何对外提供服务的\n主要的读取 socket 数据流 并将其解析成h ttp 协议格式请求的逻辑在 for 循环中 // Serve a new connection. func (c *conn) serve(ctx context.Context) { c.remoteAddr = c.rwc.RemoteAddr().String() ctx = context.WithValue(ctx, LocalAddrContextKey, c.rwc.LocalAddr()) var inFlightResponse *response // 忽略一些代码 // 处理TLS // ... // HTTP/1.x from here on. ctx, cancelCtx := context.WithCancel(ctx) c.cancelCtx = cancelCtx defer cancelCtx() c.r = \u0026connReader{conn: c} c.bufr = newBufioReader(c.r) c.bufw = newBufioWriterSize(checkConnErrorWriter{c}, 4\u003c\u003c10) // http 情趣解析重头戏 for { w, err := c.readRequest(ctx) if c.r.remain != c.server.initialReadLimitSize() { // If we read any bytes off the wire, we're active. c.setState(c.rwc, StateActive, runHooks) } if err != nil { const errorHeaders = \"\\r\\nContent-Type: text/plain; charset=utf-8\\r\\nConnection: close\\r\\n\\r\\n\" switch { case err == errTooLarge: // Their HTTP client may or may not be // able to read this if we're // responding to them and hanging up // while they're still writing their // request. Undefined behavior. const publicErr = \"431 Request Header Fields Too Large\" fmt.Fprintf(c.rwc, \"HTTP/1.1 \"+publicErr+errorHeaders+publicErr) c.closeWriteAndWait() return case isUnsupportedTEError(err): // Respond as per RFC 7230 Section 3.3.1 which says, // A server that receives a request message with a // transfer coding it does not understand SHOULD // respond with 501 (Unimplemented). code := StatusNotImplemented // We purposefully aren't echoing back the transfer-encoding's value, // so as to mitigate the risk of cross side scripting by an attacker. fmt.Fprintf(c.rwc, \"HTTP/1.1 %d %s%sUnsupported transfer encoding\", code, StatusText(code), errorHeaders) return case isCommonNetReadError(err): return // don't reply default: if v, ok := err.(statusError); ok { fmt.Fprintf(c.rwc, \"HTTP/1.1 %d %s: %s%s%d %s: %s\", v.code, StatusText(v.code), v.text, errorHeaders, v.code, StatusText(v.code), v.text) return } publicErr := \"400 Bad Request\" fmt.Fprintf(c.rwc, \"HTTP/1.1 \"+publicErr+errorHeaders+publicErr) return } } // Expect 100 Continue support req := w.req if req.expectsContinue() { if req.ProtoAtLeast(1, 1) \u0026\u0026 req.ContentLength != 0 { // Wrap the Body reader with one that replies on the connection req.Body = \u0026expectContinueReader{readCloser: req.Body, resp: w} w.canWriteContinue.Store(true) } } else if req.Header.get(\"Expect\") != \"\" { w.sendExpectationFailed() return } c.curReq.Store(w) if requestBodyRemains(req.Body) { registerOnHitEOF(req.Body, w.conn.r.startBackgroundRead) } else { w.conn.r.startBackgroundRead() } // HTTP cannot have multiple simultaneous active requests.[*] // Until the server replies to this request, it can't read another, // so we might as well run the handler in this goroutine. // [*] Not strictly true: HTTP pipelining. We could let them all process // in parallel even if their responses need to be serialized. // But we're not going to implement HTTP pipelining because it // was never deployed in the wild and the answer is HTTP/2. inFlightResponse = w serverHandler{c.server}.ServeHTTP(w, w.req) inFlightResponse = nil w.cancelCtx() if c.hijacked() { return } w.finishRequest() c.rwc.SetWriteDeadline(time.Time{}) if !w.shouldReuseConnection() { if w.requestBodyLimitHit || w.closedRequestBodyEarly() { c.closeWriteAndWait() } return } c.setState(c.rwc, StateIdle, runHooks) c.curReq.Store(nil) if !w.conn.server.doKeepAlives() { // We're in shutdown mode. We might've replied // to the user without \"Connection: close\" and // they might think they can send another // request, but such is life with HTTP/1.1. return } if d := c.server.idleTimeout(); d != 0 { c.rwc.SetReadDeadline(time.Now().Add(d)) } else { c.rwc.SetReadDeadline(time.Time{}) } // Wait for the connection to become readable again before trying to // read the next request. This prevents a ReadHeaderTimeout or // ReadTimeout from starting until the first bytes of the next request // have been received. if _, err := c.bufr.Peek(4); err != nil { return } c.rwc.SetReadDeadline(time.Time{}) } } 深入看下上面的 for 循环中 *w, err := c.readRequest(ctx)* 是怎么将数据路按 http 协议解析出来的\n读取socket 的数据流，放到内存的缓冲区中 *readRequest(b *bufio.Reader)* 逐行读取缓冲区，逐步解析请求第一行，请求头（读取请求头通过***ReadMIMEHeader() 函数***）， 独到请求头之后，根据请求的方法，请求头中的参数，再来觉得是否需要读取请求体，如果有请求体，根据请求头部字段创建body的读取器reader（r***eadTransfer(msg any, r *bufio.Reader) (err error)判断是否需要分块读取数据***） 创建response 对象 w， 并且将请求头上下文作为 response 对象的一个成员，因为在实际业务需求中经常有response数据需要使用到request 上下文的情况 // 解析 http 请求 func readRequest(b *bufio.Reader) (req *Request, err error) { tp := newTextprotoReader(b) defer putTextprotoReader(tp) req = new(Request) // First line: GET /index.html HTTP/1.0 var s string if s, err = tp.ReadLine(); err != nil { return nil, err } defer func() { if err == io.EOF { err = io.ErrUnexpectedEOF } }() // 读取请求第一行 req.Method, req.RequestURI, req.Proto, ok = parseRequestLine(s) // 读取请求头 // Subsequent lines: Key: value. mimeHeader, err := tp.ReadMIMEHeader() if err != nil { return nil, err } req.Header = Header(mimeHeader) if len(req.Header[\"Host\"]) \u003e 1 { return nil, fmt.Errorf(\"too many Host headers\") } // RFC 7230, section 5.3: Must treat //\tGET /index.html HTTP/1.1 //\tHost: www.google.com // and //\tGET http://www.google.com/index.html HTTP/1.1 //\tHost: doesntmatter // the same. In the second case, any Host line is ignored. req.Host = req.URL.Host if req.Host == \"\" { req.Host = req.Header.get(\"Host\") } fixPragmaCacheControl(req.Header) req.Close = shouldClose(req.ProtoMajor, req.ProtoMinor, req.Header, false) // 检查是否需要分块读取 err = readTransfer(req, b) if err != nil { return nil, err } if req.isH2Upgrade() { // Because it's neither chunked, nor declared: req.ContentLength = -1 // We want to give handlers a chance to hijack the // connection, but we need to prevent the Server from // dealing with the connection further if it's not // hijacked. Set Close to ensure that: req.Close = true } return req, nil } // Read next request from connection. func (c *conn) readRequest(ctx context.Context) (w *response, err error) { // 一些错误处理逻辑 // ... // 读取报文，按 http 协议解析 ——--\u003e 跳转到上面的那个函数 req, err := readRequest(c.bufr) if err != nil { if c.r.hitReadLimit() { return nil, errTooLarge } return nil, err } if !http1ServerSupportsRequest(req) { return nil, statusError{StatusHTTPVersionNotSupported, \"unsupported protocol version\"} } c.lastMethod = req.Method c.r.setInfiniteReadLimit() hosts, haveHost := req.Header[\"Host\"] isH2Upgrade := req.isH2Upgrade() if req.ProtoAtLeast(1, 1) \u0026\u0026 (!haveHost || len(hosts) == 0) \u0026\u0026 !isH2Upgrade \u0026\u0026 req.Method != \"CONNECT\" { return nil, badRequestError(\"missing required Host header\") } if len(hosts) == 1 \u0026\u0026 !httpguts.ValidHostHeader(hosts[0]) { return nil, badRequestError(\"malformed Host header\") } for k, vv := range req.Header { if !httpguts.ValidHeaderFieldName(k) { return nil, badRequestError(\"invalid header name\") } for _, v := range vv { if !httpguts.ValidHeaderFieldValue(v) { return nil, badRequestError(\"invalid header value\") } } } delete(req.Header, \"Host\") ctx, cancelCtx := context.WithCancel(ctx) req.ctx = ctx req.RemoteAddr = c.remoteAddr req.TLS = c.tlsState // 将 req.Body 接口实例化为一个对象，由用户来手动读取 htto请求体 if body, ok := req.Body.(*body); ok { body.doEarlyClose = true } // Adjust the read deadline if necessary. if !hdrDeadline.Equal(wholeReqDeadline) { c.rwc.SetReadDeadline(wholeReqDeadline) } w = \u0026response{ conn: c, cancelCtx: cancelCtx, req: req, reqBody: req.Body, handlerHeader: make(Header), contentLength: -1, closeNotifyCh: make(chan bool, 1), // We populate these ahead of time so we're not // reading from req.Header after their Handler starts // and maybe mutates it (Issue 14940) wants10KeepAlive: req.wantsHttp10KeepAlive(), wantsClose: req.wantsClose(), } if isH2Upgrade { w.closeAfterReply = true } w.cw.res = w w.w = newBufioWriterSize(\u0026w.cw, bufferBeforeChunkingSize) return w, nil } 在HTTP协议中，请求头和请求体是通过一个空行分隔的。请求头包含了客户端发送给服务器的一些元数据信息，例如请求方法、地址、协议版本、请求头字段等。而请求体则一般用于传输一些数据，例如表单数据、JSON数据等。\n为了保证灵活性和可扩展性，http框架通常只负责解析和提供请求头的相关信息，至于请求体的数据需要根据具体的业务需求来处理。由于请求体的内容格式可能是多样的，http框架无法事先预知如何解析请求体数据。因此，需要程序手动读取请求体，并根据请求头中的Content-Type字段判断请求体的数据格式，然后进行相应的解析和处理。\n以下是根据请求或者响应头部数据，判断是否需要分块读取的逻辑\n// msg is *Request or *Response. func readTransfer(msg any, r *bufio.Reader) (err error) { t := \u0026transferReader{RequestMethod: \"GET\"} // Unify input isResponse := false switch rr := msg.(type) { case *Response: t.Header = rr.Header t.StatusCode = rr.StatusCode t.ProtoMajor = rr.ProtoMajor t.ProtoMinor = rr.ProtoMinor t.Close = shouldClose(t.ProtoMajor, t.ProtoMinor, t.Header, true) isResponse = true if rr.Request != nil { t.RequestMethod = rr.Request.Method } case *Request: t.Header = rr.Header t.RequestMethod = rr.Method t.ProtoMajor = rr.ProtoMajor t.ProtoMinor = rr.ProtoMinor // Transfer semantics for Requests are exactly like those for // Responses with status code 200, responding to a GET method t.StatusCode = 200 t.Close = rr.Close default: panic(\"unexpected type\") } // Default to HTTP/1.1 if t.ProtoMajor == 0 \u0026\u0026 t.ProtoMinor == 0 { t.ProtoMajor, t.ProtoMinor = 1, 1 } // Transfer-Encoding: chunked, and overriding Content-Length. if err := t.parseTransferEncoding(); err != nil { return err } realLength, err := fixLength(isResponse, t.StatusCode, t.RequestMethod, t.Header, t.Chunked) if err != nil { return err } if isResponse \u0026\u0026 t.RequestMethod == \"HEAD\" { if n, err := parseContentLength(t.Header.get(\"Content-Length\")); err != nil { return err } else { t.ContentLength = n } } else { t.ContentLength = realLength } // Trailer t.Trailer, err = fixTrailer(t.Header, t.Chunked) if err != nil { return err } // If there is no Content-Length or chunked Transfer-Encoding on a *Response // and the status is not 1xx, 204 or 304, then the body is unbounded. // See RFC 7230, section 3.3. switch msg.(type) { case *Response: if realLength == -1 \u0026\u0026 !t.Chunked \u0026\u0026 bodyAllowedForStatus(t.StatusCode) { // Unbounded body. t.Close = true } } // Prepare body reader. ContentLength \u003c 0 means chunked encoding // or close connection when finished, since multipart is not supported yet switch { case t.Chunked: if isResponse \u0026\u0026 (noResponseBodyExpected(t.RequestMethod) || !bodyAllowedForStatus(t.StatusCode)) { t.Body = NoBody } else { t.Body = \u0026body{src: internal.NewChunkedReader(r), hdr: msg, r: r, closing: t.Close} } case realLength == 0: t.Body = NoBody case realLength \u003e 0: t.Body = \u0026body{src: io.LimitReader(r, realLength), closing: t.Close} default: // realLength \u003c 0, i.e. \"Content-Length\" not mentioned in header if t.Close { // Close semantics (i.e. HTTP/1.0) t.Body = \u0026body{src: r, closing: t.Close} } else { // Persistent connection (i.e. HTTP/1.1) t.Body = NoBody } } // Unify output switch rr := msg.(type) { case *Request: rr.Body = t.Body rr.ContentLength = t.ContentLength if t.Chunked { rr.TransferEncoding = []string{\"chunked\"} } rr.Close = t.Close rr.Trailer = t.Trailer case *Response: rr.Body = t.Body rr.ContentLength = t.ContentLength if t.Chunked { rr.TransferEncoding = []string{\"chunked\"} } rr.Close = t.Close rr.Trailer = t.Trailer } return nil } 好现在让我们返回到之前的for循环,，这个是之前监听套件字上获取一个然后开启的一个协程，携程里的重头戏是for循环。\n// Serve a new connection. func (c *conn) serve(ctx context.Context) { c.remoteAddr = c.rwc.RemoteAddr().String() ctx = context.WithValue(ctx, LocalAddrContextKey, c.rwc.LocalAddr()) var inFlightResponse *response // 忽略一些代码 // 处理TLS // ... // HTTP/1.x from here on. ctx, cancelCtx := context.WithCancel(ctx) c.cancelCtx = cancelCtx defer cancelCtx() c.r = \u0026connReader{conn: c} c.bufr = newBufioReader(c.r) c.bufw = newBufioWriterSize(checkConnErrorWriter{c}, 4\u003c\u003c10) // http 情趣解析重头戏 for { w, err := c.readRequest(ctx) // 删去了一些错误处理，让代码主逻辑体现出来 // HTTP cannot have multiple simultaneous active requests.[*] // Until the server replies to this request, it can't read another, // so we might as well run the handler in this goroutine. // [*] Not strictly true: HTTP pipelining. We could let them all process // in parallel even if their responses need to be serialized. // But we're not going to implement HTTP pipelining because it // was never deployed in the wild and the answer is HTTP/2. inFlightResponse = w // 这里调用的 ServerHTTP 函数其实就是 我们在 main 函数中传入的 handler （其实也就是路由殷勤） router := routers.NewRouter() //\ts := \u0026http.Server{ //\tAddr: \":\" + global.ServerSetting.HttpPort, //\tHandler: router, //\tReadTimeout: global.ServerSetting.ReadTimeout, //\tWriteTimeout: global.ServerSetting.WriteTimeout, //\tMaxHeaderBytes: 1 \u003c\u003c 20, //\t} serverHandler{c.server}.ServeHTTP(w, w.req) // 做一些收尾工作，例如心跳机制等 // ..... } } 接下来我们来单独分析下 serverHandler{c.server}.ServeHTTP(w, w.req) 是如何工作的\n前半部分***serverHandler{c.server}.*** 其实是创建了一个临时对象，这个对象有个成员是一个指向Server 的指针，事实上，c.server 就是我们在 main 函数中初始化的那个 server 对象，在监听套接字 accept 到新连接时，会创建一个 conn 连接对象，每个 conn 对象都会获取main 函数中建立的 server 的指针作为自己的一个数据成员，所以这个 c.server 其实就是我们main 函数中穿件的 server 后半部分，这个临时对象调用一个叫做 ServeHTTP(w, w.req) 的方法，传入参数为我们上面解析出来的 request 和 response type serverHandler struct { srv *Server } type conn struct { // server is the server on which the connection arrived. // Immutable; never nil. server *Server // cancelCtx cancels the connection-level context. cancelCtx context.CancelFunc // rwc is the underlying network connection. // This is never wrapped by other types and is the value given out // to CloseNotifier callers. It is usually of type *net.TCPConn or // *tls.Conn. rwc net.Conn // remoteAddr is rwc.RemoteAddr().String(). It is not populated synchronously // inside the Listener's Accept goroutine, as some implementations block. // It is populated immediately inside the (*conn).serve goroutine. // This is the value of a Handler's (*Request).RemoteAddr. remoteAddr string // tlsState is the TLS connection state when using TLS. // nil means not TLS. tlsState *tls.ConnectionState // werr is set to the first write error to rwc. // It is set via checkConnErrorWriter{w}, where bufw writes. werr error // r is bufr's read source. It's a wrapper around rwc that provides // io.LimitedReader-style limiting (while reading request headers) // and functionality to support CloseNotifier. See *connReader docs. r *connReader // bufr reads from r. bufr *bufio.Reader // bufw writes to checkConnErrorWriter{c}, which populates werr on error. bufw *bufio.Writer // lastMethod is the method of the most recent request // on this connection, if any. lastMethod string curReq atomic.Pointer[response] // (which has a Request in it) curState atomic.Uint64 // packed (unixtime\u003c\u003c8|uint8(ConnState)) // mu guards hijackedv mu sync.Mutex // hijackedv is whether this connection has been hijacked // by a Handler with the Hijacker interface. // It is guarded by mu. hijackedv bool } 接下来看看 serverHandler{c.server}.ServeHTTP(w, w.req) 具体的做了什么\n第一行获取 main 函数中创建的 server ，将这个server 的 handler 对象，也就是 router 路由引擎单独拿出来 最后一行，执行 router 路由引擎中的 ServeHTTP(rw, req) 函数 // main() //\trouter := routers.NewRouter() //\ts := \u0026http.Server{ //\tAddr: \":\" + global.ServerSetting.HttpPort, //\tHandler: router, //\tReadTimeout: global.ServerSetting.ReadTimeout, //\tWriteTimeout: global.ServerSetting.WriteTimeout, //\tMaxHeaderBytes: 1 \u003c\u003c 20, //\t} func (sh serverHandler) ServeHTTP(rw ResponseWriter, req *Request) { // 获取 main 函数中创建的 server ，将这个server 的 handler 对象，也就是 router 路由引擎单独拿出来 handler := sh.srv.Handler if handler == nil { handler = DefaultServeMux } if !sh.srv.DisableGeneralOptionsHandler \u0026\u0026 req.RequestURI == \"*\" \u0026\u0026 req.Method == \"OPTIONS\" { handler = globalOptionsHandler{} } if req.URL != nil \u0026\u0026 strings.Contains(req.URL.RawQuery, \";\") { var allowQuerySemicolonsInUse atomic.Bool req = req.WithContext(context.WithValue(req.Context(), silenceSemWarnContextKey, func() { allowQuerySemicolonsInUse.Store(true) })) defer func() { if !allowQuerySemicolonsInUse.Load() { sh.srv.logf(\"http: URL query contains semicolon, which is no longer a supported separator; parts of the query may be stripped when parsed; see golang.org/issue/25192\") } }() } handler.ServeHTTP(rw, req) } 接着我们砖到 router 路由引擎对象 的 engin 类， 我们接着看\nfunc (engine *Engine) ServeHTTP(w http.ResponseWriter, req *http.Request) 做了什么\n从 Context 内存池中获取一快内存 把 req 和 responseWriter 塞到 Context 里面 调用 ***engine.handleHTTPRequest(c)*** 函数，这个函数会根据 http 请求头里的 method 和 path在 radix tree （前缀树，一个method 代表一个树的跟节点）中找到对应的节点 node， 节点 node 上挂载着用户在注册路由时同时注册进来的处理方法 handler 执行当前请求的路由上注册的对应handler，是一个回调函数，由用户提前注册好 用户注册的业务逻辑执行完成后，会向responseWrite 缓冲区写入数据，响应返回给客户端 type Engine struct { RouterGroup // Enables automatic redirection if the current route can't be matched but a // handler for the path with (without) the trailing slash exists. // For example if /foo/ is requested but a route only exists for /foo, the // client is redirected to /foo with http status code 301 for GET requests // and 307 for all other request methods. RedirectTrailingSlash bool // If enabled, the router tries to fix the current request path, if no // handle is registered for it. // First superfluous path elements like ../ or // are removed. // Afterwards the router does a case-insensitive lookup of the cleaned path. // If a handle can be found for this route, the router makes a redirection // to the corrected path with status code 301 for GET requests and 307 for // all other request methods. // For example /FOO and /..//Foo could be redirected to /foo. // RedirectTrailingSlash is independent of this option. RedirectFixedPath bool // If enabled, the router checks if another method is allowed for the // current route, if the current request can not be routed. // If this is the case, the request is answered with 'Method Not Allowed' // and HTTP status code 405. // If no other Method is allowed, the request is delegated to the NotFound // handler. HandleMethodNotAllowed bool ForwardedByClientIP bool // #726 #755 If enabled, it will thrust some headers starting with // 'X-AppEngine...' for better integration with that PaaS. AppEngine bool // If enabled, the url.RawPath will be used to find parameters. UseRawPath bool // If true, the path value will be unescaped. // If UseRawPath is false (by default), the UnescapePathValues effectively is true, // as url.Path gonna be used, which is already unescaped. UnescapePathValues bool // Value of 'maxMemory' param that is given to http.Request's ParseMultipartForm // method call. MaxMultipartMemory int64 // RemoveExtraSlash a parameter can be parsed from the URL even with extra slashes. // See the PR #1817 and issue #1644 RemoveExtraSlash bool delims render.Delims secureJsonPrefix string HTMLRender render.HTMLRender FuncMap template.FuncMap allNoRoute HandlersChain allNoMethod HandlersChain noRoute HandlersChain noMethod HandlersChain pool sync.Pool trees methodTrees // 前缀树 } // ServeHTTP conforms to the http.Handler interface. func (engine *Engine) ServeHTTP(w http.ResponseWriter, req *http.Request) { c := engine.pool.Get().(*Context) c.writermem.reset(w) c.Request = req c.reset() engine.handleHTTPRequest(c) engine.pool.Put(c) } func (engine *Engine) handleHTTPRequest(c *Context) { httpMethod := c.Request.Method rPath := c.Request.URL.Path unescape := false if engine.UseRawPath \u0026\u0026 len(c.Request.URL.RawPath) \u003e 0 { rPath = c.Request.URL.RawPath unescape = engine.UnescapePathValues } if engine.RemoveExtraSlash { rPath = cleanPath(rPath) } // Find root of the tree for the given HTTP method t := engine.trees for i, tl := 0, len(t); i \u003c tl; i++ { if t[i].method != httpMethod { continue } root := t[i].root // Find route in tree value := root.getValue(rPath, c.Params, unescape) if value.handlers != nil { c.handlers = value.handlers c.Params = value.params c.fullPath = value.fullPath c.Next() // 执行节点上用户注册的的路由的处理函数 handler c.writermem.WriteHeaderNow() return } if httpMethod != \"CONNECT\" \u0026\u0026 rPath != \"/\" { if value.tsr \u0026\u0026 engine.RedirectTrailingSlash { redirectTrailingSlash(c) return } if engine.RedirectFixedPath \u0026\u0026 redirectFixedPath(c, root, engine.RedirectFixedPath) { return } } break } if engine.HandleMethodNotAllowed { for _, tree := range engine.trees { if tree.method == httpMethod { continue } if value := tree.root.getValue(rPath, nil, unescape); value.handlers != nil { c.handlers = engine.allNoMethod serveError(c, http.StatusMethodNotAllowed, default405Body) return } } } c.handlers = engine.allNoRoute serveError(c, http.StatusNotFound, default404Body) } // 迭代器，依次执行 handler func (c *Context) Next() { c.index++ for c.index \u003c int8(len(c.handlers)) { c.handlers[c.index](c) c.index++ } } 顺带看下前缀树\n// 树的根节点 type methodTree struct { method string root *node } // 树的节点 type nodeValue struct { handlers HandlersChain params Params tsr bool fullPath string } ","wordCount":"3034","inLanguage":"en","datePublished":"2024-02-09T12:15:13+08:00","dateModified":"2024-02-09T12:15:13+08:00","author":{"@type":"Person","name":"Me"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://LinPr.github.io/posts/go_http%E8%BF%9E%E6%8E%A5%E5%BB%BA%E7%AB%8B%E5%92%8C%E5%A4%84%E7%90%86/"},"publisher":{"@type":"Organization","name":"Mr.LinPr Hugo Site","logo":{"@type":"ImageObject","url":"https://LinPr.github.io/%3Clink%20/%20abs%20url%3E"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://LinPr.github.io/ accesskey=h title="Home (Alt + H)"><img src=https://LinPr.github.io/apple-touch-icon.png alt aria-label=logo height=35>Home</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://LinPr.github.io/categories/ title=categories><span>categories</span></a></li><li><a href=https://LinPr.github.io/tags/ title=tags><span>tags</span></a></li><li><a href=https://example.org title=example.org><span>example.org</span>&nbsp;<svg fill="none" shape-rendering="geometricPrecision" stroke="currentcolor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" viewBox="0 0 24 24" height="12" width="12"><path d="M18 13v6a2 2 0 01-2 2H5a2 2 0 01-2-2V8a2 2 0 012-2h6"/><path d="M15 3h6v6"/><path d="M10 14 21 3"/></svg></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://LinPr.github.io/>Home</a>&nbsp;»&nbsp;<a href=https://LinPr.github.io/posts/>Posts</a></div><h1 class="post-title entry-hint-parent">Go_Http连接建立和处理</h1><div class=post-meta><span title='2024-02-09 12:15:13 +0800 CST'>February 9, 2024</span>&nbsp;·&nbsp;15 min&nbsp;·&nbsp;3034 words&nbsp;·&nbsp;Me&nbsp;|&nbsp;<a href=https://github.com/%3cpath_to_repo%3e/content/posts/go_Http%e8%bf%9e%e6%8e%a5%e5%bb%ba%e7%ab%8b%e5%92%8c%e5%a4%84%e7%90%86.md rel="noopener noreferrer" target=_blank>Suggest Changes</a></div></header><div class=toc><details open><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><nav id=TableOfContents><ul><li><ul><li><a href=#接收-http-请求并执行的过程>接收 http 请求并执行的过程</a></li></ul></li></ul></nav></div></details></div><div class=post-content><h1 id=http-连接建立和处理>http 连接建立和处理<a hidden class=anchor aria-hidden=true href=#http-连接建立和处理>#</a></h1><h3 id=接收-http-请求并执行的过程>接收 http 请求并执行的过程<a hidden class=anchor aria-hidden=true href=#接收-http-请求并执行的过程>#</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=k>go</span> <span class=kd>func</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>s</span><span class=p>.</span><span class=nf>ListenAndServe</span><span class=p>();</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=o>&amp;&amp;</span> <span class=nx>err</span> <span class=o>!=</span> <span class=nx>http</span><span class=p>.</span><span class=nx>ErrServerClosed</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nx>log</span><span class=p>.</span><span class=nf>Fatalf</span><span class=p>(</span><span class=s>&#34;s.ListenAndServe err: %v&#34;</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=p>}()</span>
</span></span></code></pre></div><p>前面提到， 在路由引初始化完成后，注册对应的路由和 handler，接下来在 main 函数中 http.Server 就会监听指定的端口，我们来看下http.Server 是如何接收请求并执行对应的处理函数的</p><p>httpServer 会调用 Serve(l net.Listener 函数，这个函数主要做了以下几件事情</p><ol><li>在一个循环里面不断监听套接字是否有链接请求上来，如果有的话，创建一个新的连接对象</li><li>这个连接对象中有，有两个成员，一个是套接字对象（实现了conn接口），一个是指向service对象的指针</li><li>最后一行，通过启动一个新的协程来处理连接事务，并对外提供服务</li></ol><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>srv</span> <span class=o>*</span><span class=nx>Server</span><span class=p>)</span> <span class=nf>newConn</span><span class=p>(</span><span class=nx>rwc</span> <span class=nx>net</span><span class=p>.</span><span class=nx>Conn</span><span class=p>)</span> <span class=o>*</span><span class=nx>conn</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>c</span> <span class=o>:=</span> <span class=o>&amp;</span><span class=nx>conn</span><span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>server</span><span class=p>:</span> <span class=nx>srv</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=nx>rwc</span><span class=p>:</span>    <span class=nx>rwc</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>debugServerConnections</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>c</span><span class=p>.</span><span class=nx>rwc</span> <span class=p>=</span> <span class=nf>newLoggingConn</span><span class=p>(</span><span class=s>&#34;server&#34;</span><span class=p>,</span> <span class=nx>c</span><span class=p>.</span><span class=nx>rwc</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=nx>c</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>srv</span> <span class=o>*</span><span class=nx>Server</span><span class=p>)</span> <span class=nf>Serve</span><span class=p>(</span><span class=nx>l</span> <span class=nx>net</span><span class=p>.</span><span class=nx>Listener</span><span class=p>)</span> <span class=kt>error</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>fn</span> <span class=o>:=</span> <span class=nx>testHookServerServe</span><span class=p>;</span> <span class=nx>fn</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nf>fn</span><span class=p>(</span><span class=nx>srv</span><span class=p>,</span> <span class=nx>l</span><span class=p>)</span> <span class=c1>// call hook with unwrapped listener
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>origListener</span> <span class=o>:=</span> <span class=nx>l</span>
</span></span><span class=line><span class=cl>	<span class=nx>l</span> <span class=p>=</span> <span class=o>&amp;</span><span class=nx>onceCloseListener</span><span class=p>{</span><span class=nx>Listener</span><span class=p>:</span> <span class=nx>l</span><span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=k>defer</span> <span class=nx>l</span><span class=p>.</span><span class=nf>Close</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>srv</span><span class=p>.</span><span class=nf>setupHTTP2_Serve</span><span class=p>();</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=nx>err</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=p>!</span><span class=nx>srv</span><span class=p>.</span><span class=nf>trackListener</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>l</span><span class=p>,</span> <span class=kc>true</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=nx>ErrServerClosed</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=k>defer</span> <span class=nx>srv</span><span class=p>.</span><span class=nf>trackListener</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>l</span><span class=p>,</span> <span class=kc>false</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>baseCtx</span> <span class=o>:=</span> <span class=nx>context</span><span class=p>.</span><span class=nf>Background</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>srv</span><span class=p>.</span><span class=nx>BaseContext</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>baseCtx</span> <span class=p>=</span> <span class=nx>srv</span><span class=p>.</span><span class=nf>BaseContext</span><span class=p>(</span><span class=nx>origListener</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=nx>baseCtx</span> <span class=o>==</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nb>panic</span><span class=p>(</span><span class=s>&#34;BaseContext returned a nil context&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=kd>var</span> <span class=nx>tempDelay</span> <span class=nx>time</span><span class=p>.</span><span class=nx>Duration</span> <span class=c1>// how long to sleep on accept failure
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>	<span class=nx>ctx</span> <span class=o>:=</span> <span class=nx>context</span><span class=p>.</span><span class=nf>WithValue</span><span class=p>(</span><span class=nx>baseCtx</span><span class=p>,</span> <span class=nx>ServerContextKey</span><span class=p>,</span> <span class=nx>srv</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>for</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>rw</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>l</span><span class=p>.</span><span class=nf>Accept</span><span class=p>()</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=k>if</span> <span class=nx>srv</span><span class=p>.</span><span class=nf>shuttingDown</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=k>return</span> <span class=nx>ErrServerClosed</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span>
</span></span><span class=line><span class=cl>			<span class=k>if</span> <span class=nx>ne</span><span class=p>,</span> <span class=nx>ok</span> <span class=o>:=</span> <span class=nx>err</span><span class=p>.(</span><span class=nx>net</span><span class=p>.</span><span class=nx>Error</span><span class=p>);</span> <span class=nx>ok</span> <span class=o>&amp;&amp;</span> <span class=nx>ne</span><span class=p>.</span><span class=nf>Temporary</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=k>if</span> <span class=nx>tempDelay</span> <span class=o>==</span> <span class=mi>0</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>					<span class=nx>tempDelay</span> <span class=p>=</span> <span class=mi>5</span> <span class=o>*</span> <span class=nx>time</span><span class=p>.</span><span class=nx>Millisecond</span>
</span></span><span class=line><span class=cl>				<span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>					<span class=nx>tempDelay</span> <span class=o>*=</span> <span class=mi>2</span>
</span></span><span class=line><span class=cl>				<span class=p>}</span>
</span></span><span class=line><span class=cl>				<span class=k>if</span> <span class=nx>max</span> <span class=o>:=</span> <span class=mi>1</span> <span class=o>*</span> <span class=nx>time</span><span class=p>.</span><span class=nx>Second</span><span class=p>;</span> <span class=nx>tempDelay</span> <span class=p>&gt;</span> <span class=nx>max</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>					<span class=nx>tempDelay</span> <span class=p>=</span> <span class=nx>max</span>
</span></span><span class=line><span class=cl>				<span class=p>}</span>
</span></span><span class=line><span class=cl>				<span class=nx>srv</span><span class=p>.</span><span class=nf>logf</span><span class=p>(</span><span class=s>&#34;http: Accept error: %v; retrying in %v&#34;</span><span class=p>,</span> <span class=nx>err</span><span class=p>,</span> <span class=nx>tempDelay</span><span class=p>)</span>
</span></span><span class=line><span class=cl>				<span class=nx>time</span><span class=p>.</span><span class=nf>Sleep</span><span class=p>(</span><span class=nx>tempDelay</span><span class=p>)</span>
</span></span><span class=line><span class=cl>				<span class=k>continue</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span>
</span></span><span class=line><span class=cl>			<span class=k>return</span> <span class=nx>err</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=nx>connCtx</span> <span class=o>:=</span> <span class=nx>ctx</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=nx>cc</span> <span class=o>:=</span> <span class=nx>srv</span><span class=p>.</span><span class=nx>ConnContext</span><span class=p>;</span> <span class=nx>cc</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nx>connCtx</span> <span class=p>=</span> <span class=nf>cc</span><span class=p>(</span><span class=nx>connCtx</span><span class=p>,</span> <span class=nx>rw</span><span class=p>)</span>
</span></span><span class=line><span class=cl>			<span class=k>if</span> <span class=nx>connCtx</span> <span class=o>==</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=nb>panic</span><span class=p>(</span><span class=s>&#34;ConnContext returned nil&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=nx>tempDelay</span> <span class=p>=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>		<span class=nx>c</span> <span class=o>:=</span> <span class=nx>srv</span><span class=p>.</span><span class=nf>newConn</span><span class=p>(</span><span class=nx>rw</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=nx>c</span><span class=p>.</span><span class=nf>setState</span><span class=p>(</span><span class=nx>c</span><span class=p>.</span><span class=nx>rwc</span><span class=p>,</span> <span class=nx>StateNew</span><span class=p>,</span> <span class=nx>runHooks</span><span class=p>)</span> <span class=c1>// before Serve can return
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=k>go</span> <span class=nx>c</span><span class=p>.</span><span class=nf>serve</span><span class=p>(</span><span class=nx>connCtx</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>继续往下看，我们看每个 accept 的连接是如何对外提供服务的</p><ol><li>主要的读取 socket 数据流 并将其解析成h ttp 协议格式请求的逻辑在 for 循环中</li></ol><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=c1>// Serve a new connection.
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>func</span> <span class=p>(</span><span class=nx>c</span> <span class=o>*</span><span class=nx>conn</span><span class=p>)</span> <span class=nf>serve</span><span class=p>(</span><span class=nx>ctx</span> <span class=nx>context</span><span class=p>.</span><span class=nx>Context</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>c</span><span class=p>.</span><span class=nx>remoteAddr</span> <span class=p>=</span> <span class=nx>c</span><span class=p>.</span><span class=nx>rwc</span><span class=p>.</span><span class=nf>RemoteAddr</span><span class=p>().</span><span class=nf>String</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=nx>ctx</span> <span class=p>=</span> <span class=nx>context</span><span class=p>.</span><span class=nf>WithValue</span><span class=p>(</span><span class=nx>ctx</span><span class=p>,</span> <span class=nx>LocalAddrContextKey</span><span class=p>,</span> <span class=nx>c</span><span class=p>.</span><span class=nx>rwc</span><span class=p>.</span><span class=nf>LocalAddr</span><span class=p>())</span>
</span></span><span class=line><span class=cl>	<span class=kd>var</span> <span class=nx>inFlightResponse</span> <span class=o>*</span><span class=nx>response</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// 忽略一些代码
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>	<span class=c1>// 处理TLS
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// ...
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>	<span class=c1>// HTTP/1.x from here on.
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>	<span class=nx>ctx</span><span class=p>,</span> <span class=nx>cancelCtx</span> <span class=o>:=</span> <span class=nx>context</span><span class=p>.</span><span class=nf>WithCancel</span><span class=p>(</span><span class=nx>ctx</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=nx>c</span><span class=p>.</span><span class=nx>cancelCtx</span> <span class=p>=</span> <span class=nx>cancelCtx</span>
</span></span><span class=line><span class=cl>	<span class=k>defer</span> <span class=nf>cancelCtx</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>c</span><span class=p>.</span><span class=nx>r</span> <span class=p>=</span> <span class=o>&amp;</span><span class=nx>connReader</span><span class=p>{</span><span class=nx>conn</span><span class=p>:</span> <span class=nx>c</span><span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=nx>c</span><span class=p>.</span><span class=nx>bufr</span> <span class=p>=</span> <span class=nf>newBufioReader</span><span class=p>(</span><span class=nx>c</span><span class=p>.</span><span class=nx>r</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=nx>c</span><span class=p>.</span><span class=nx>bufw</span> <span class=p>=</span> <span class=nf>newBufioWriterSize</span><span class=p>(</span><span class=nx>checkConnErrorWriter</span><span class=p>{</span><span class=nx>c</span><span class=p>},</span> <span class=mi>4</span><span class=o>&lt;&lt;</span><span class=mi>10</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// http 情趣解析重头戏
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>	<span class=k>for</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>w</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>c</span><span class=p>.</span><span class=nf>readRequest</span><span class=p>(</span><span class=nx>ctx</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=nx>c</span><span class=p>.</span><span class=nx>r</span><span class=p>.</span><span class=nx>remain</span> <span class=o>!=</span> <span class=nx>c</span><span class=p>.</span><span class=nx>server</span><span class=p>.</span><span class=nf>initialReadLimitSize</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=c1>// If we read any bytes off the wire, we&#39;re active.
</span></span></span><span class=line><span class=cl><span class=c1></span>			<span class=nx>c</span><span class=p>.</span><span class=nf>setState</span><span class=p>(</span><span class=nx>c</span><span class=p>.</span><span class=nx>rwc</span><span class=p>,</span> <span class=nx>StateActive</span><span class=p>,</span> <span class=nx>runHooks</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=kd>const</span> <span class=nx>errorHeaders</span> <span class=p>=</span> <span class=s>&#34;\r\nContent-Type: text/plain; charset=utf-8\r\nConnection: close\r\n\r\n&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>			<span class=k>switch</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=k>case</span> <span class=nx>err</span> <span class=o>==</span> <span class=nx>errTooLarge</span><span class=p>:</span>
</span></span><span class=line><span class=cl>				<span class=c1>// Their HTTP client may or may not be
</span></span></span><span class=line><span class=cl><span class=c1></span>				<span class=c1>// able to read this if we&#39;re
</span></span></span><span class=line><span class=cl><span class=c1></span>				<span class=c1>// responding to them and hanging up
</span></span></span><span class=line><span class=cl><span class=c1></span>				<span class=c1>// while they&#39;re still writing their
</span></span></span><span class=line><span class=cl><span class=c1></span>				<span class=c1>// request. Undefined behavior.
</span></span></span><span class=line><span class=cl><span class=c1></span>				<span class=kd>const</span> <span class=nx>publicErr</span> <span class=p>=</span> <span class=s>&#34;431 Request Header Fields Too Large&#34;</span>
</span></span><span class=line><span class=cl>				<span class=nx>fmt</span><span class=p>.</span><span class=nf>Fprintf</span><span class=p>(</span><span class=nx>c</span><span class=p>.</span><span class=nx>rwc</span><span class=p>,</span> <span class=s>&#34;HTTP/1.1 &#34;</span><span class=o>+</span><span class=nx>publicErr</span><span class=o>+</span><span class=nx>errorHeaders</span><span class=o>+</span><span class=nx>publicErr</span><span class=p>)</span>
</span></span><span class=line><span class=cl>				<span class=nx>c</span><span class=p>.</span><span class=nf>closeWriteAndWait</span><span class=p>()</span>
</span></span><span class=line><span class=cl>				<span class=k>return</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>			<span class=k>case</span> <span class=nf>isUnsupportedTEError</span><span class=p>(</span><span class=nx>err</span><span class=p>):</span>
</span></span><span class=line><span class=cl>				<span class=c1>// Respond as per RFC 7230 Section 3.3.1 which says,
</span></span></span><span class=line><span class=cl><span class=c1></span>				<span class=c1>//      A server that receives a request message with a
</span></span></span><span class=line><span class=cl><span class=c1></span>				<span class=c1>//      transfer coding it does not understand SHOULD
</span></span></span><span class=line><span class=cl><span class=c1></span>				<span class=c1>//      respond with 501 (Unimplemented).
</span></span></span><span class=line><span class=cl><span class=c1></span>				<span class=nx>code</span> <span class=o>:=</span> <span class=nx>StatusNotImplemented</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>				<span class=c1>// We purposefully aren&#39;t echoing back the transfer-encoding&#39;s value,
</span></span></span><span class=line><span class=cl><span class=c1></span>				<span class=c1>// so as to mitigate the risk of cross side scripting by an attacker.
</span></span></span><span class=line><span class=cl><span class=c1></span>				<span class=nx>fmt</span><span class=p>.</span><span class=nf>Fprintf</span><span class=p>(</span><span class=nx>c</span><span class=p>.</span><span class=nx>rwc</span><span class=p>,</span> <span class=s>&#34;HTTP/1.1 %d %s%sUnsupported transfer encoding&#34;</span><span class=p>,</span> <span class=nx>code</span><span class=p>,</span> <span class=nf>StatusText</span><span class=p>(</span><span class=nx>code</span><span class=p>),</span> <span class=nx>errorHeaders</span><span class=p>)</span>
</span></span><span class=line><span class=cl>				<span class=k>return</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>			<span class=k>case</span> <span class=nf>isCommonNetReadError</span><span class=p>(</span><span class=nx>err</span><span class=p>):</span>
</span></span><span class=line><span class=cl>				<span class=k>return</span> <span class=c1>// don&#39;t reply
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>			<span class=k>default</span><span class=p>:</span>
</span></span><span class=line><span class=cl>				<span class=k>if</span> <span class=nx>v</span><span class=p>,</span> <span class=nx>ok</span> <span class=o>:=</span> <span class=nx>err</span><span class=p>.(</span><span class=nx>statusError</span><span class=p>);</span> <span class=nx>ok</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>					<span class=nx>fmt</span><span class=p>.</span><span class=nf>Fprintf</span><span class=p>(</span><span class=nx>c</span><span class=p>.</span><span class=nx>rwc</span><span class=p>,</span> <span class=s>&#34;HTTP/1.1 %d %s: %s%s%d %s: %s&#34;</span><span class=p>,</span> <span class=nx>v</span><span class=p>.</span><span class=nx>code</span><span class=p>,</span> <span class=nf>StatusText</span><span class=p>(</span><span class=nx>v</span><span class=p>.</span><span class=nx>code</span><span class=p>),</span> <span class=nx>v</span><span class=p>.</span><span class=nx>text</span><span class=p>,</span> <span class=nx>errorHeaders</span><span class=p>,</span> <span class=nx>v</span><span class=p>.</span><span class=nx>code</span><span class=p>,</span> <span class=nf>StatusText</span><span class=p>(</span><span class=nx>v</span><span class=p>.</span><span class=nx>code</span><span class=p>),</span> <span class=nx>v</span><span class=p>.</span><span class=nx>text</span><span class=p>)</span>
</span></span><span class=line><span class=cl>					<span class=k>return</span>
</span></span><span class=line><span class=cl>				<span class=p>}</span>
</span></span><span class=line><span class=cl>				<span class=nx>publicErr</span> <span class=o>:=</span> <span class=s>&#34;400 Bad Request&#34;</span>
</span></span><span class=line><span class=cl>				<span class=nx>fmt</span><span class=p>.</span><span class=nf>Fprintf</span><span class=p>(</span><span class=nx>c</span><span class=p>.</span><span class=nx>rwc</span><span class=p>,</span> <span class=s>&#34;HTTP/1.1 &#34;</span><span class=o>+</span><span class=nx>publicErr</span><span class=o>+</span><span class=nx>errorHeaders</span><span class=o>+</span><span class=nx>publicErr</span><span class=p>)</span>
</span></span><span class=line><span class=cl>				<span class=k>return</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>		<span class=c1>// Expect 100 Continue support
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=nx>req</span> <span class=o>:=</span> <span class=nx>w</span><span class=p>.</span><span class=nx>req</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=nx>req</span><span class=p>.</span><span class=nf>expectsContinue</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=k>if</span> <span class=nx>req</span><span class=p>.</span><span class=nf>ProtoAtLeast</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span> <span class=mi>1</span><span class=p>)</span> <span class=o>&amp;&amp;</span> <span class=nx>req</span><span class=p>.</span><span class=nx>ContentLength</span> <span class=o>!=</span> <span class=mi>0</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=c1>// Wrap the Body reader with one that replies on the connection
</span></span></span><span class=line><span class=cl><span class=c1></span>				<span class=nx>req</span><span class=p>.</span><span class=nx>Body</span> <span class=p>=</span> <span class=o>&amp;</span><span class=nx>expectContinueReader</span><span class=p>{</span><span class=nx>readCloser</span><span class=p>:</span> <span class=nx>req</span><span class=p>.</span><span class=nx>Body</span><span class=p>,</span> <span class=nx>resp</span><span class=p>:</span> <span class=nx>w</span><span class=p>}</span>
</span></span><span class=line><span class=cl>				<span class=nx>w</span><span class=p>.</span><span class=nx>canWriteContinue</span><span class=p>.</span><span class=nf>Store</span><span class=p>(</span><span class=kc>true</span><span class=p>)</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span> <span class=k>else</span> <span class=k>if</span> <span class=nx>req</span><span class=p>.</span><span class=nx>Header</span><span class=p>.</span><span class=nf>get</span><span class=p>(</span><span class=s>&#34;Expect&#34;</span><span class=p>)</span> <span class=o>!=</span> <span class=s>&#34;&#34;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nx>w</span><span class=p>.</span><span class=nf>sendExpectationFailed</span><span class=p>()</span>
</span></span><span class=line><span class=cl>			<span class=k>return</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>		<span class=nx>c</span><span class=p>.</span><span class=nx>curReq</span><span class=p>.</span><span class=nf>Store</span><span class=p>(</span><span class=nx>w</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=nf>requestBodyRemains</span><span class=p>(</span><span class=nx>req</span><span class=p>.</span><span class=nx>Body</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nf>registerOnHitEOF</span><span class=p>(</span><span class=nx>req</span><span class=p>.</span><span class=nx>Body</span><span class=p>,</span> <span class=nx>w</span><span class=p>.</span><span class=nx>conn</span><span class=p>.</span><span class=nx>r</span><span class=p>.</span><span class=nx>startBackgroundRead</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nx>w</span><span class=p>.</span><span class=nx>conn</span><span class=p>.</span><span class=nx>r</span><span class=p>.</span><span class=nf>startBackgroundRead</span><span class=p>()</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>		<span class=c1>// HTTP cannot have multiple simultaneous active requests.[*]
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=c1>// Until the server replies to this request, it can&#39;t read another,
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=c1>// so we might as well run the handler in this goroutine.
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=c1>// [*] Not strictly true: HTTP pipelining. We could let them all process
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=c1>// in parallel even if their responses need to be serialized.
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=c1>// But we&#39;re not going to implement HTTP pipelining because it
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=c1>// was never deployed in the wild and the answer is HTTP/2.
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=nx>inFlightResponse</span> <span class=p>=</span> <span class=nx>w</span>
</span></span><span class=line><span class=cl>		<span class=nx>serverHandler</span><span class=p>{</span><span class=nx>c</span><span class=p>.</span><span class=nx>server</span><span class=p>}.</span><span class=nf>ServeHTTP</span><span class=p>(</span><span class=nx>w</span><span class=p>,</span> <span class=nx>w</span><span class=p>.</span><span class=nx>req</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=nx>inFlightResponse</span> <span class=p>=</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl>		<span class=nx>w</span><span class=p>.</span><span class=nf>cancelCtx</span><span class=p>()</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=nx>c</span><span class=p>.</span><span class=nf>hijacked</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=k>return</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=nx>w</span><span class=p>.</span><span class=nf>finishRequest</span><span class=p>()</span>
</span></span><span class=line><span class=cl>		<span class=nx>c</span><span class=p>.</span><span class=nx>rwc</span><span class=p>.</span><span class=nf>SetWriteDeadline</span><span class=p>(</span><span class=nx>time</span><span class=p>.</span><span class=nx>Time</span><span class=p>{})</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=p>!</span><span class=nx>w</span><span class=p>.</span><span class=nf>shouldReuseConnection</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=k>if</span> <span class=nx>w</span><span class=p>.</span><span class=nx>requestBodyLimitHit</span> <span class=o>||</span> <span class=nx>w</span><span class=p>.</span><span class=nf>closedRequestBodyEarly</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=nx>c</span><span class=p>.</span><span class=nf>closeWriteAndWait</span><span class=p>()</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span>
</span></span><span class=line><span class=cl>			<span class=k>return</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=nx>c</span><span class=p>.</span><span class=nf>setState</span><span class=p>(</span><span class=nx>c</span><span class=p>.</span><span class=nx>rwc</span><span class=p>,</span> <span class=nx>StateIdle</span><span class=p>,</span> <span class=nx>runHooks</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=nx>c</span><span class=p>.</span><span class=nx>curReq</span><span class=p>.</span><span class=nf>Store</span><span class=p>(</span><span class=kc>nil</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=p>!</span><span class=nx>w</span><span class=p>.</span><span class=nx>conn</span><span class=p>.</span><span class=nx>server</span><span class=p>.</span><span class=nf>doKeepAlives</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=c1>// We&#39;re in shutdown mode. We might&#39;ve replied
</span></span></span><span class=line><span class=cl><span class=c1></span>			<span class=c1>// to the user without &#34;Connection: close&#34; and
</span></span></span><span class=line><span class=cl><span class=c1></span>			<span class=c1>// they might think they can send another
</span></span></span><span class=line><span class=cl><span class=c1></span>			<span class=c1>// request, but such is life with HTTP/1.1.
</span></span></span><span class=line><span class=cl><span class=c1></span>			<span class=k>return</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=nx>d</span> <span class=o>:=</span> <span class=nx>c</span><span class=p>.</span><span class=nx>server</span><span class=p>.</span><span class=nf>idleTimeout</span><span class=p>();</span> <span class=nx>d</span> <span class=o>!=</span> <span class=mi>0</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nx>c</span><span class=p>.</span><span class=nx>rwc</span><span class=p>.</span><span class=nf>SetReadDeadline</span><span class=p>(</span><span class=nx>time</span><span class=p>.</span><span class=nf>Now</span><span class=p>().</span><span class=nf>Add</span><span class=p>(</span><span class=nx>d</span><span class=p>))</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nx>c</span><span class=p>.</span><span class=nx>rwc</span><span class=p>.</span><span class=nf>SetReadDeadline</span><span class=p>(</span><span class=nx>time</span><span class=p>.</span><span class=nx>Time</span><span class=p>{})</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>		<span class=c1>// Wait for the connection to become readable again before trying to
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=c1>// read the next request. This prevents a ReadHeaderTimeout or
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=c1>// ReadTimeout from starting until the first bytes of the next request
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=c1>// have been received.
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=k>if</span> <span class=nx>_</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>c</span><span class=p>.</span><span class=nx>bufr</span><span class=p>.</span><span class=nf>Peek</span><span class=p>(</span><span class=mi>4</span><span class=p>);</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=k>return</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>		<span class=nx>c</span><span class=p>.</span><span class=nx>rwc</span><span class=p>.</span><span class=nf>SetReadDeadline</span><span class=p>(</span><span class=nx>time</span><span class=p>.</span><span class=nx>Time</span><span class=p>{})</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>深入看下上面的 for 循环中 <code>*w, err := c.readRequest(ctx)*</code> 是怎么将数据路按 http 协议解析出来的</p><ol><li>读取socket 的数据流，放到内存的缓冲区中</li><li><strong><code>*readRequest(b *bufio.Reader)*</code></strong> 逐行读取缓冲区，逐步解析请求第一行，请求头（读取请求头通过***<code>ReadMIMEHeader() 函数</code>***），</li><li>独到请求头之后，根据请求的方法，请求头中的参数，再来觉得是否需要读取请求体，如果有请求体，根据请求头部字段创建body的读取器reader（r**<code>*eadTransfer(msg any, r *bufio.Reader) (err error)</code>判断是否需要分块读取数据***）</li><li>创建response 对象 w， 并且将请求头上下文作为 response 对象的一个成员，因为在实际业务需求中经常有response数据需要使用到request 上下文的情况</li></ol><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// 解析 http 请求
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>func</span> <span class=nf>readRequest</span><span class=p>(</span><span class=nx>b</span> <span class=o>*</span><span class=nx>bufio</span><span class=p>.</span><span class=nx>Reader</span><span class=p>)</span> <span class=p>(</span><span class=nx>req</span> <span class=o>*</span><span class=nx>Request</span><span class=p>,</span> <span class=nx>err</span> <span class=kt>error</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>tp</span> <span class=o>:=</span> <span class=nf>newTextprotoReader</span><span class=p>(</span><span class=nx>b</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>defer</span> <span class=nf>putTextprotoReader</span><span class=p>(</span><span class=nx>tp</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>req</span> <span class=p>=</span> <span class=nb>new</span><span class=p>(</span><span class=nx>Request</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// First line: GET /index.html HTTP/1.0
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=kd>var</span> <span class=nx>s</span> <span class=kt>string</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>s</span><span class=p>,</span> <span class=nx>err</span> <span class=p>=</span> <span class=nx>tp</span><span class=p>.</span><span class=nf>ReadLine</span><span class=p>();</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=kc>nil</span><span class=p>,</span> <span class=nx>err</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=k>defer</span> <span class=kd>func</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=nx>err</span> <span class=o>==</span> <span class=nx>io</span><span class=p>.</span><span class=nx>EOF</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nx>err</span> <span class=p>=</span> <span class=nx>io</span><span class=p>.</span><span class=nx>ErrUnexpectedEOF</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=p>}()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// 读取请求第一行
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>req</span><span class=p>.</span><span class=nx>Method</span><span class=p>,</span> <span class=nx>req</span><span class=p>.</span><span class=nx>RequestURI</span><span class=p>,</span> <span class=nx>req</span><span class=p>.</span><span class=nx>Proto</span><span class=p>,</span> <span class=nx>ok</span> <span class=p>=</span> <span class=nf>parseRequestLine</span><span class=p>(</span><span class=nx>s</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// 读取请求头
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// Subsequent lines: Key: value.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>mimeHeader</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>tp</span><span class=p>.</span><span class=nf>ReadMIMEHeader</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=kc>nil</span><span class=p>,</span> <span class=nx>err</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=nx>req</span><span class=p>.</span><span class=nx>Header</span> <span class=p>=</span> <span class=nf>Header</span><span class=p>(</span><span class=nx>mimeHeader</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=nx>req</span><span class=p>.</span><span class=nx>Header</span><span class=p>[</span><span class=s>&#34;Host&#34;</span><span class=p>])</span> <span class=p>&gt;</span> <span class=mi>1</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=kc>nil</span><span class=p>,</span> <span class=nx>fmt</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span><span class=s>&#34;too many Host headers&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// RFC 7230, section 5.3: Must treat
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>//	GET /index.html HTTP/1.1
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>//	Host: www.google.com
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// and
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>//	GET http://www.google.com/index.html HTTP/1.1
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>//	Host: doesntmatter
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// the same. In the second case, any Host line is ignored.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>req</span><span class=p>.</span><span class=nx>Host</span> <span class=p>=</span> <span class=nx>req</span><span class=p>.</span><span class=nx>URL</span><span class=p>.</span><span class=nx>Host</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>req</span><span class=p>.</span><span class=nx>Host</span> <span class=o>==</span> <span class=s>&#34;&#34;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>req</span><span class=p>.</span><span class=nx>Host</span> <span class=p>=</span> <span class=nx>req</span><span class=p>.</span><span class=nx>Header</span><span class=p>.</span><span class=nf>get</span><span class=p>(</span><span class=s>&#34;Host&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nf>fixPragmaCacheControl</span><span class=p>(</span><span class=nx>req</span><span class=p>.</span><span class=nx>Header</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>req</span><span class=p>.</span><span class=nx>Close</span> <span class=p>=</span> <span class=nf>shouldClose</span><span class=p>(</span><span class=nx>req</span><span class=p>.</span><span class=nx>ProtoMajor</span><span class=p>,</span> <span class=nx>req</span><span class=p>.</span><span class=nx>ProtoMinor</span><span class=p>,</span> <span class=nx>req</span><span class=p>.</span><span class=nx>Header</span><span class=p>,</span> <span class=kc>false</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// 检查是否需要分块读取
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>err</span> <span class=p>=</span> <span class=nf>readTransfer</span><span class=p>(</span><span class=nx>req</span><span class=p>,</span> <span class=nx>b</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=kc>nil</span><span class=p>,</span> <span class=nx>err</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>req</span><span class=p>.</span><span class=nf>isH2Upgrade</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=c1>// Because it&#39;s neither chunked, nor declared:
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=nx>req</span><span class=p>.</span><span class=nx>ContentLength</span> <span class=p>=</span> <span class=o>-</span><span class=mi>1</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>		<span class=c1>// We want to give handlers a chance to hijack the
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=c1>// connection, but we need to prevent the Server from
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=c1>// dealing with the connection further if it&#39;s not
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=c1>// hijacked. Set Close to ensure that:
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=nx>req</span><span class=p>.</span><span class=nx>Close</span> <span class=p>=</span> <span class=kc>true</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=nx>req</span><span class=p>,</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Read next request from connection.
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>func</span> <span class=p>(</span><span class=nx>c</span> <span class=o>*</span><span class=nx>conn</span><span class=p>)</span> <span class=nf>readRequest</span><span class=p>(</span><span class=nx>ctx</span> <span class=nx>context</span><span class=p>.</span><span class=nx>Context</span><span class=p>)</span> <span class=p>(</span><span class=nx>w</span> <span class=o>*</span><span class=nx>response</span><span class=p>,</span> <span class=nx>err</span> <span class=kt>error</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	
</span></span><span class=line><span class=cl>	<span class=c1>// 一些错误处理逻辑 
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// ...
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>	
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// 读取报文，按 http 协议解析 ——--&gt; 跳转到上面的那个函数
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>req</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nf>readRequest</span><span class=p>(</span><span class=nx>c</span><span class=p>.</span><span class=nx>bufr</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=nx>c</span><span class=p>.</span><span class=nx>r</span><span class=p>.</span><span class=nf>hitReadLimit</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=k>return</span> <span class=kc>nil</span><span class=p>,</span> <span class=nx>errTooLarge</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=kc>nil</span><span class=p>,</span> <span class=nx>err</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=p>!</span><span class=nf>http1ServerSupportsRequest</span><span class=p>(</span><span class=nx>req</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=kc>nil</span><span class=p>,</span> <span class=nx>statusError</span><span class=p>{</span><span class=nx>StatusHTTPVersionNotSupported</span><span class=p>,</span> <span class=s>&#34;unsupported protocol version&#34;</span><span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>c</span><span class=p>.</span><span class=nx>lastMethod</span> <span class=p>=</span> <span class=nx>req</span><span class=p>.</span><span class=nx>Method</span>
</span></span><span class=line><span class=cl>	<span class=nx>c</span><span class=p>.</span><span class=nx>r</span><span class=p>.</span><span class=nf>setInfiniteReadLimit</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>hosts</span><span class=p>,</span> <span class=nx>haveHost</span> <span class=o>:=</span> <span class=nx>req</span><span class=p>.</span><span class=nx>Header</span><span class=p>[</span><span class=s>&#34;Host&#34;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>	<span class=nx>isH2Upgrade</span> <span class=o>:=</span> <span class=nx>req</span><span class=p>.</span><span class=nf>isH2Upgrade</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>req</span><span class=p>.</span><span class=nf>ProtoAtLeast</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span> <span class=mi>1</span><span class=p>)</span> <span class=o>&amp;&amp;</span> <span class=p>(!</span><span class=nx>haveHost</span> <span class=o>||</span> <span class=nb>len</span><span class=p>(</span><span class=nx>hosts</span><span class=p>)</span> <span class=o>==</span> <span class=mi>0</span><span class=p>)</span> <span class=o>&amp;&amp;</span> <span class=p>!</span><span class=nx>isH2Upgrade</span> <span class=o>&amp;&amp;</span> <span class=nx>req</span><span class=p>.</span><span class=nx>Method</span> <span class=o>!=</span> <span class=s>&#34;CONNECT&#34;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=kc>nil</span><span class=p>,</span> <span class=nf>badRequestError</span><span class=p>(</span><span class=s>&#34;missing required Host header&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=nx>hosts</span><span class=p>)</span> <span class=o>==</span> <span class=mi>1</span> <span class=o>&amp;&amp;</span> <span class=p>!</span><span class=nx>httpguts</span><span class=p>.</span><span class=nf>ValidHostHeader</span><span class=p>(</span><span class=nx>hosts</span><span class=p>[</span><span class=mi>0</span><span class=p>])</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=kc>nil</span><span class=p>,</span> <span class=nf>badRequestError</span><span class=p>(</span><span class=s>&#34;malformed Host header&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=k>for</span> <span class=nx>k</span><span class=p>,</span> <span class=nx>vv</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>req</span><span class=p>.</span><span class=nx>Header</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=p>!</span><span class=nx>httpguts</span><span class=p>.</span><span class=nf>ValidHeaderFieldName</span><span class=p>(</span><span class=nx>k</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=k>return</span> <span class=kc>nil</span><span class=p>,</span> <span class=nf>badRequestError</span><span class=p>(</span><span class=s>&#34;invalid header name&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=k>for</span> <span class=nx>_</span><span class=p>,</span> <span class=nx>v</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>vv</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=k>if</span> <span class=p>!</span><span class=nx>httpguts</span><span class=p>.</span><span class=nf>ValidHeaderFieldValue</span><span class=p>(</span><span class=nx>v</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=k>return</span> <span class=kc>nil</span><span class=p>,</span> <span class=nf>badRequestError</span><span class=p>(</span><span class=s>&#34;invalid header value&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=nb>delete</span><span class=p>(</span><span class=nx>req</span><span class=p>.</span><span class=nx>Header</span><span class=p>,</span> <span class=s>&#34;Host&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>ctx</span><span class=p>,</span> <span class=nx>cancelCtx</span> <span class=o>:=</span> <span class=nx>context</span><span class=p>.</span><span class=nf>WithCancel</span><span class=p>(</span><span class=nx>ctx</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=nx>req</span><span class=p>.</span><span class=nx>ctx</span> <span class=p>=</span> <span class=nx>ctx</span>
</span></span><span class=line><span class=cl>	<span class=nx>req</span><span class=p>.</span><span class=nx>RemoteAddr</span> <span class=p>=</span> <span class=nx>c</span><span class=p>.</span><span class=nx>remoteAddr</span>
</span></span><span class=line><span class=cl>	<span class=nx>req</span><span class=p>.</span><span class=nx>TLS</span> <span class=p>=</span> <span class=nx>c</span><span class=p>.</span><span class=nx>tlsState</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// 将 req.Body 接口实例化为一个对象，由用户来手动读取 htto请求体
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=k>if</span> <span class=nx>body</span><span class=p>,</span> <span class=nx>ok</span> <span class=o>:=</span> <span class=nx>req</span><span class=p>.</span><span class=nx>Body</span><span class=p>.(</span><span class=o>*</span><span class=nx>body</span><span class=p>);</span> <span class=nx>ok</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>body</span><span class=p>.</span><span class=nx>doEarlyClose</span> <span class=p>=</span> <span class=kc>true</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// Adjust the read deadline if necessary.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=k>if</span> <span class=p>!</span><span class=nx>hdrDeadline</span><span class=p>.</span><span class=nf>Equal</span><span class=p>(</span><span class=nx>wholeReqDeadline</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>c</span><span class=p>.</span><span class=nx>rwc</span><span class=p>.</span><span class=nf>SetReadDeadline</span><span class=p>(</span><span class=nx>wholeReqDeadline</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>w</span> <span class=p>=</span> <span class=o>&amp;</span><span class=nx>response</span><span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>conn</span><span class=p>:</span>          <span class=nx>c</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=nx>cancelCtx</span><span class=p>:</span>     <span class=nx>cancelCtx</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=nx>req</span><span class=p>:</span>           <span class=nx>req</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=nx>reqBody</span><span class=p>:</span>       <span class=nx>req</span><span class=p>.</span><span class=nx>Body</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=nx>handlerHeader</span><span class=p>:</span> <span class=nb>make</span><span class=p>(</span><span class=nx>Header</span><span class=p>),</span>
</span></span><span class=line><span class=cl>		<span class=nx>contentLength</span><span class=p>:</span> <span class=o>-</span><span class=mi>1</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=nx>closeNotifyCh</span><span class=p>:</span> <span class=nb>make</span><span class=p>(</span><span class=kd>chan</span> <span class=kt>bool</span><span class=p>,</span> <span class=mi>1</span><span class=p>),</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>		<span class=c1>// We populate these ahead of time so we&#39;re not
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=c1>// reading from req.Header after their Handler starts
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=c1>// and maybe mutates it (Issue 14940)
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=nx>wants10KeepAlive</span><span class=p>:</span> <span class=nx>req</span><span class=p>.</span><span class=nf>wantsHttp10KeepAlive</span><span class=p>(),</span>
</span></span><span class=line><span class=cl>		<span class=nx>wantsClose</span><span class=p>:</span>       <span class=nx>req</span><span class=p>.</span><span class=nf>wantsClose</span><span class=p>(),</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>isH2Upgrade</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>w</span><span class=p>.</span><span class=nx>closeAfterReply</span> <span class=p>=</span> <span class=kc>true</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=nx>w</span><span class=p>.</span><span class=nx>cw</span><span class=p>.</span><span class=nx>res</span> <span class=p>=</span> <span class=nx>w</span>
</span></span><span class=line><span class=cl>	<span class=nx>w</span><span class=p>.</span><span class=nx>w</span> <span class=p>=</span> <span class=nf>newBufioWriterSize</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>w</span><span class=p>.</span><span class=nx>cw</span><span class=p>,</span> <span class=nx>bufferBeforeChunkingSize</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=nx>w</span><span class=p>,</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>在HTTP协议中，请求头和请求体是通过一个空行分隔的。请求头包含了客户端发送给服务器的一些元数据信息，例如请求方法、地址、协议版本、请求头字段等。而请求体则一般用于传输一些数据，例如表单数据、JSON数据等。</p><p>为了保证灵活性和可扩展性，http框架通常只负责解析和提供请求头的相关信息，至于请求体的数据需要根据具体的业务需求来处理。由于请求体的内容格式可能是多样的，http框架无法事先预知如何解析请求体数据。因此，需要程序手动读取请求体，并根据请求头中的Content-Type字段判断请求体的数据格式，然后进行相应的解析和处理。</p><p>以下是根据请求或者响应头部数据，判断是否需要分块读取的逻辑</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=c1>// msg is *Request or *Response.
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>func</span> <span class=nf>readTransfer</span><span class=p>(</span><span class=nx>msg</span> <span class=nx>any</span><span class=p>,</span> <span class=nx>r</span> <span class=o>*</span><span class=nx>bufio</span><span class=p>.</span><span class=nx>Reader</span><span class=p>)</span> <span class=p>(</span><span class=nx>err</span> <span class=kt>error</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>t</span> <span class=o>:=</span> <span class=o>&amp;</span><span class=nx>transferReader</span><span class=p>{</span><span class=nx>RequestMethod</span><span class=p>:</span> <span class=s>&#34;GET&#34;</span><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// Unify input
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>isResponse</span> <span class=o>:=</span> <span class=kc>false</span>
</span></span><span class=line><span class=cl>	<span class=k>switch</span> <span class=nx>rr</span> <span class=o>:=</span> <span class=nx>msg</span><span class=p>.(</span><span class=kd>type</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=k>case</span> <span class=o>*</span><span class=nx>Response</span><span class=p>:</span>
</span></span><span class=line><span class=cl>		<span class=nx>t</span><span class=p>.</span><span class=nx>Header</span> <span class=p>=</span> <span class=nx>rr</span><span class=p>.</span><span class=nx>Header</span>
</span></span><span class=line><span class=cl>		<span class=nx>t</span><span class=p>.</span><span class=nx>StatusCode</span> <span class=p>=</span> <span class=nx>rr</span><span class=p>.</span><span class=nx>StatusCode</span>
</span></span><span class=line><span class=cl>		<span class=nx>t</span><span class=p>.</span><span class=nx>ProtoMajor</span> <span class=p>=</span> <span class=nx>rr</span><span class=p>.</span><span class=nx>ProtoMajor</span>
</span></span><span class=line><span class=cl>		<span class=nx>t</span><span class=p>.</span><span class=nx>ProtoMinor</span> <span class=p>=</span> <span class=nx>rr</span><span class=p>.</span><span class=nx>ProtoMinor</span>
</span></span><span class=line><span class=cl>		<span class=nx>t</span><span class=p>.</span><span class=nx>Close</span> <span class=p>=</span> <span class=nf>shouldClose</span><span class=p>(</span><span class=nx>t</span><span class=p>.</span><span class=nx>ProtoMajor</span><span class=p>,</span> <span class=nx>t</span><span class=p>.</span><span class=nx>ProtoMinor</span><span class=p>,</span> <span class=nx>t</span><span class=p>.</span><span class=nx>Header</span><span class=p>,</span> <span class=kc>true</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=nx>isResponse</span> <span class=p>=</span> <span class=kc>true</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=nx>rr</span><span class=p>.</span><span class=nx>Request</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nx>t</span><span class=p>.</span><span class=nx>RequestMethod</span> <span class=p>=</span> <span class=nx>rr</span><span class=p>.</span><span class=nx>Request</span><span class=p>.</span><span class=nx>Method</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=k>case</span> <span class=o>*</span><span class=nx>Request</span><span class=p>:</span>
</span></span><span class=line><span class=cl>		<span class=nx>t</span><span class=p>.</span><span class=nx>Header</span> <span class=p>=</span> <span class=nx>rr</span><span class=p>.</span><span class=nx>Header</span>
</span></span><span class=line><span class=cl>		<span class=nx>t</span><span class=p>.</span><span class=nx>RequestMethod</span> <span class=p>=</span> <span class=nx>rr</span><span class=p>.</span><span class=nx>Method</span>
</span></span><span class=line><span class=cl>		<span class=nx>t</span><span class=p>.</span><span class=nx>ProtoMajor</span> <span class=p>=</span> <span class=nx>rr</span><span class=p>.</span><span class=nx>ProtoMajor</span>
</span></span><span class=line><span class=cl>		<span class=nx>t</span><span class=p>.</span><span class=nx>ProtoMinor</span> <span class=p>=</span> <span class=nx>rr</span><span class=p>.</span><span class=nx>ProtoMinor</span>
</span></span><span class=line><span class=cl>		<span class=c1>// Transfer semantics for Requests are exactly like those for
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=c1>// Responses with status code 200, responding to a GET method
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=nx>t</span><span class=p>.</span><span class=nx>StatusCode</span> <span class=p>=</span> <span class=mi>200</span>
</span></span><span class=line><span class=cl>		<span class=nx>t</span><span class=p>.</span><span class=nx>Close</span> <span class=p>=</span> <span class=nx>rr</span><span class=p>.</span><span class=nx>Close</span>
</span></span><span class=line><span class=cl>	<span class=k>default</span><span class=p>:</span>
</span></span><span class=line><span class=cl>		<span class=nb>panic</span><span class=p>(</span><span class=s>&#34;unexpected type&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// Default to HTTP/1.1
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=k>if</span> <span class=nx>t</span><span class=p>.</span><span class=nx>ProtoMajor</span> <span class=o>==</span> <span class=mi>0</span> <span class=o>&amp;&amp;</span> <span class=nx>t</span><span class=p>.</span><span class=nx>ProtoMinor</span> <span class=o>==</span> <span class=mi>0</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>t</span><span class=p>.</span><span class=nx>ProtoMajor</span><span class=p>,</span> <span class=nx>t</span><span class=p>.</span><span class=nx>ProtoMinor</span> <span class=p>=</span> <span class=mi>1</span><span class=p>,</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// Transfer-Encoding: chunked, and overriding Content-Length.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=k>if</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>t</span><span class=p>.</span><span class=nf>parseTransferEncoding</span><span class=p>();</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=nx>err</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>realLength</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nf>fixLength</span><span class=p>(</span><span class=nx>isResponse</span><span class=p>,</span> <span class=nx>t</span><span class=p>.</span><span class=nx>StatusCode</span><span class=p>,</span> <span class=nx>t</span><span class=p>.</span><span class=nx>RequestMethod</span><span class=p>,</span> <span class=nx>t</span><span class=p>.</span><span class=nx>Header</span><span class=p>,</span> <span class=nx>t</span><span class=p>.</span><span class=nx>Chunked</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=nx>err</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>isResponse</span> <span class=o>&amp;&amp;</span> <span class=nx>t</span><span class=p>.</span><span class=nx>RequestMethod</span> <span class=o>==</span> <span class=s>&#34;HEAD&#34;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=nx>n</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nf>parseContentLength</span><span class=p>(</span><span class=nx>t</span><span class=p>.</span><span class=nx>Header</span><span class=p>.</span><span class=nf>get</span><span class=p>(</span><span class=s>&#34;Content-Length&#34;</span><span class=p>));</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=k>return</span> <span class=nx>err</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nx>t</span><span class=p>.</span><span class=nx>ContentLength</span> <span class=p>=</span> <span class=nx>n</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>t</span><span class=p>.</span><span class=nx>ContentLength</span> <span class=p>=</span> <span class=nx>realLength</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// Trailer
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>t</span><span class=p>.</span><span class=nx>Trailer</span><span class=p>,</span> <span class=nx>err</span> <span class=p>=</span> <span class=nf>fixTrailer</span><span class=p>(</span><span class=nx>t</span><span class=p>.</span><span class=nx>Header</span><span class=p>,</span> <span class=nx>t</span><span class=p>.</span><span class=nx>Chunked</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=nx>err</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// If there is no Content-Length or chunked Transfer-Encoding on a *Response
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// and the status is not 1xx, 204 or 304, then the body is unbounded.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// See RFC 7230, section 3.3.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=k>switch</span> <span class=nx>msg</span><span class=p>.(</span><span class=kd>type</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=k>case</span> <span class=o>*</span><span class=nx>Response</span><span class=p>:</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=nx>realLength</span> <span class=o>==</span> <span class=o>-</span><span class=mi>1</span> <span class=o>&amp;&amp;</span> <span class=p>!</span><span class=nx>t</span><span class=p>.</span><span class=nx>Chunked</span> <span class=o>&amp;&amp;</span> <span class=nf>bodyAllowedForStatus</span><span class=p>(</span><span class=nx>t</span><span class=p>.</span><span class=nx>StatusCode</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=c1>// Unbounded body.
</span></span></span><span class=line><span class=cl><span class=c1></span>			<span class=nx>t</span><span class=p>.</span><span class=nx>Close</span> <span class=p>=</span> <span class=kc>true</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// Prepare body reader. ContentLength &lt; 0 means chunked encoding
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// or close connection when finished, since multipart is not supported yet
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=k>switch</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=k>case</span> <span class=nx>t</span><span class=p>.</span><span class=nx>Chunked</span><span class=p>:</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=nx>isResponse</span> <span class=o>&amp;&amp;</span> <span class=p>(</span><span class=nf>noResponseBodyExpected</span><span class=p>(</span><span class=nx>t</span><span class=p>.</span><span class=nx>RequestMethod</span><span class=p>)</span> <span class=o>||</span> <span class=p>!</span><span class=nf>bodyAllowedForStatus</span><span class=p>(</span><span class=nx>t</span><span class=p>.</span><span class=nx>StatusCode</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nx>t</span><span class=p>.</span><span class=nx>Body</span> <span class=p>=</span> <span class=nx>NoBody</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nx>t</span><span class=p>.</span><span class=nx>Body</span> <span class=p>=</span> <span class=o>&amp;</span><span class=nx>body</span><span class=p>{</span><span class=nx>src</span><span class=p>:</span> <span class=nx>internal</span><span class=p>.</span><span class=nf>NewChunkedReader</span><span class=p>(</span><span class=nx>r</span><span class=p>),</span> <span class=nx>hdr</span><span class=p>:</span> <span class=nx>msg</span><span class=p>,</span> <span class=nx>r</span><span class=p>:</span> <span class=nx>r</span><span class=p>,</span> <span class=nx>closing</span><span class=p>:</span> <span class=nx>t</span><span class=p>.</span><span class=nx>Close</span><span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=k>case</span> <span class=nx>realLength</span> <span class=o>==</span> <span class=mi>0</span><span class=p>:</span>
</span></span><span class=line><span class=cl>		<span class=nx>t</span><span class=p>.</span><span class=nx>Body</span> <span class=p>=</span> <span class=nx>NoBody</span>
</span></span><span class=line><span class=cl>	<span class=k>case</span> <span class=nx>realLength</span> <span class=p>&gt;</span> <span class=mi>0</span><span class=p>:</span>
</span></span><span class=line><span class=cl>		<span class=nx>t</span><span class=p>.</span><span class=nx>Body</span> <span class=p>=</span> <span class=o>&amp;</span><span class=nx>body</span><span class=p>{</span><span class=nx>src</span><span class=p>:</span> <span class=nx>io</span><span class=p>.</span><span class=nf>LimitReader</span><span class=p>(</span><span class=nx>r</span><span class=p>,</span> <span class=nx>realLength</span><span class=p>),</span> <span class=nx>closing</span><span class=p>:</span> <span class=nx>t</span><span class=p>.</span><span class=nx>Close</span><span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=k>default</span><span class=p>:</span>
</span></span><span class=line><span class=cl>		<span class=c1>// realLength &lt; 0, i.e. &#34;Content-Length&#34; not mentioned in header
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=k>if</span> <span class=nx>t</span><span class=p>.</span><span class=nx>Close</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=c1>// Close semantics (i.e. HTTP/1.0)
</span></span></span><span class=line><span class=cl><span class=c1></span>			<span class=nx>t</span><span class=p>.</span><span class=nx>Body</span> <span class=p>=</span> <span class=o>&amp;</span><span class=nx>body</span><span class=p>{</span><span class=nx>src</span><span class=p>:</span> <span class=nx>r</span><span class=p>,</span> <span class=nx>closing</span><span class=p>:</span> <span class=nx>t</span><span class=p>.</span><span class=nx>Close</span><span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=c1>// Persistent connection (i.e. HTTP/1.1)
</span></span></span><span class=line><span class=cl><span class=c1></span>			<span class=nx>t</span><span class=p>.</span><span class=nx>Body</span> <span class=p>=</span> <span class=nx>NoBody</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// Unify output
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=k>switch</span> <span class=nx>rr</span> <span class=o>:=</span> <span class=nx>msg</span><span class=p>.(</span><span class=kd>type</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=k>case</span> <span class=o>*</span><span class=nx>Request</span><span class=p>:</span>
</span></span><span class=line><span class=cl>		<span class=nx>rr</span><span class=p>.</span><span class=nx>Body</span> <span class=p>=</span> <span class=nx>t</span><span class=p>.</span><span class=nx>Body</span>
</span></span><span class=line><span class=cl>		<span class=nx>rr</span><span class=p>.</span><span class=nx>ContentLength</span> <span class=p>=</span> <span class=nx>t</span><span class=p>.</span><span class=nx>ContentLength</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=nx>t</span><span class=p>.</span><span class=nx>Chunked</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nx>rr</span><span class=p>.</span><span class=nx>TransferEncoding</span> <span class=p>=</span> <span class=p>[]</span><span class=kt>string</span><span class=p>{</span><span class=s>&#34;chunked&#34;</span><span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=nx>rr</span><span class=p>.</span><span class=nx>Close</span> <span class=p>=</span> <span class=nx>t</span><span class=p>.</span><span class=nx>Close</span>
</span></span><span class=line><span class=cl>		<span class=nx>rr</span><span class=p>.</span><span class=nx>Trailer</span> <span class=p>=</span> <span class=nx>t</span><span class=p>.</span><span class=nx>Trailer</span>
</span></span><span class=line><span class=cl>	<span class=k>case</span> <span class=o>*</span><span class=nx>Response</span><span class=p>:</span>
</span></span><span class=line><span class=cl>		<span class=nx>rr</span><span class=p>.</span><span class=nx>Body</span> <span class=p>=</span> <span class=nx>t</span><span class=p>.</span><span class=nx>Body</span>
</span></span><span class=line><span class=cl>		<span class=nx>rr</span><span class=p>.</span><span class=nx>ContentLength</span> <span class=p>=</span> <span class=nx>t</span><span class=p>.</span><span class=nx>ContentLength</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=nx>t</span><span class=p>.</span><span class=nx>Chunked</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nx>rr</span><span class=p>.</span><span class=nx>TransferEncoding</span> <span class=p>=</span> <span class=p>[]</span><span class=kt>string</span><span class=p>{</span><span class=s>&#34;chunked&#34;</span><span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=nx>rr</span><span class=p>.</span><span class=nx>Close</span> <span class=p>=</span> <span class=nx>t</span><span class=p>.</span><span class=nx>Close</span>
</span></span><span class=line><span class=cl>		<span class=nx>rr</span><span class=p>.</span><span class=nx>Trailer</span> <span class=p>=</span> <span class=nx>t</span><span class=p>.</span><span class=nx>Trailer</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>好现在让我们返回到之前的for循环,，这个是之前监听套件字上获取一个然后开启的一个协程，携程里的重头戏是for循环。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=c1>// Serve a new connection.
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>func</span> <span class=p>(</span><span class=nx>c</span> <span class=o>*</span><span class=nx>conn</span><span class=p>)</span> <span class=nf>serve</span><span class=p>(</span><span class=nx>ctx</span> <span class=nx>context</span><span class=p>.</span><span class=nx>Context</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>c</span><span class=p>.</span><span class=nx>remoteAddr</span> <span class=p>=</span> <span class=nx>c</span><span class=p>.</span><span class=nx>rwc</span><span class=p>.</span><span class=nf>RemoteAddr</span><span class=p>().</span><span class=nf>String</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=nx>ctx</span> <span class=p>=</span> <span class=nx>context</span><span class=p>.</span><span class=nf>WithValue</span><span class=p>(</span><span class=nx>ctx</span><span class=p>,</span> <span class=nx>LocalAddrContextKey</span><span class=p>,</span> <span class=nx>c</span><span class=p>.</span><span class=nx>rwc</span><span class=p>.</span><span class=nf>LocalAddr</span><span class=p>())</span>
</span></span><span class=line><span class=cl>	<span class=kd>var</span> <span class=nx>inFlightResponse</span> <span class=o>*</span><span class=nx>response</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// 忽略一些代码
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>	<span class=c1>// 处理TLS
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// ...
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>	<span class=c1>// HTTP/1.x from here on.
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>	<span class=nx>ctx</span><span class=p>,</span> <span class=nx>cancelCtx</span> <span class=o>:=</span> <span class=nx>context</span><span class=p>.</span><span class=nf>WithCancel</span><span class=p>(</span><span class=nx>ctx</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=nx>c</span><span class=p>.</span><span class=nx>cancelCtx</span> <span class=p>=</span> <span class=nx>cancelCtx</span>
</span></span><span class=line><span class=cl>	<span class=k>defer</span> <span class=nf>cancelCtx</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>c</span><span class=p>.</span><span class=nx>r</span> <span class=p>=</span> <span class=o>&amp;</span><span class=nx>connReader</span><span class=p>{</span><span class=nx>conn</span><span class=p>:</span> <span class=nx>c</span><span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=nx>c</span><span class=p>.</span><span class=nx>bufr</span> <span class=p>=</span> <span class=nf>newBufioReader</span><span class=p>(</span><span class=nx>c</span><span class=p>.</span><span class=nx>r</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=nx>c</span><span class=p>.</span><span class=nx>bufw</span> <span class=p>=</span> <span class=nf>newBufioWriterSize</span><span class=p>(</span><span class=nx>checkConnErrorWriter</span><span class=p>{</span><span class=nx>c</span><span class=p>},</span> <span class=mi>4</span><span class=o>&lt;&lt;</span><span class=mi>10</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// http 情趣解析重头戏
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>	<span class=k>for</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>w</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>c</span><span class=p>.</span><span class=nf>readRequest</span><span class=p>(</span><span class=nx>ctx</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>		<span class=c1>// 删去了一些错误处理，让代码主逻辑体现出来
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>		<span class=c1>// HTTP cannot have multiple simultaneous active requests.[*]
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=c1>// Until the server replies to this request, it can&#39;t read another,
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=c1>// so we might as well run the handler in this goroutine.
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=c1>// [*] Not strictly true: HTTP pipelining. We could let them all process
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=c1>// in parallel even if their responses need to be serialized.
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=c1>// But we&#39;re not going to implement HTTP pipelining because it
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=c1>// was never deployed in the wild and the answer is HTTP/2.
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=nx>inFlightResponse</span> <span class=p>=</span> <span class=nx>w</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>		
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>		<span class=c1>// 这里调用的 ServerHTTP 函数其实就是 我们在 main 函数中传入的 handler （其实也就是路由殷勤）
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=nx>router</span> <span class=o>:=</span> <span class=nx>routers</span><span class=p>.</span><span class=nf>NewRouter</span><span class=p>()</span>
</span></span><span class=line><span class=cl>		<span class=c1>//		s := &amp;http.Server{
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=c1>//			Addr:           &#34;:&#34; + global.ServerSetting.HttpPort,
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=c1>//			Handler:        router,
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=c1>//			ReadTimeout:    global.ServerSetting.ReadTimeout,
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=c1>//			WriteTimeout:   global.ServerSetting.WriteTimeout,
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=c1>//			MaxHeaderBytes: 1 &lt;&lt; 20,
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=c1>//		}
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=nx>serverHandler</span><span class=p>{</span><span class=nx>c</span><span class=p>.</span><span class=nx>server</span><span class=p>}.</span><span class=nf>ServeHTTP</span><span class=p>(</span><span class=nx>w</span><span class=p>,</span> <span class=nx>w</span><span class=p>.</span><span class=nx>req</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	
</span></span><span class=line><span class=cl>		<span class=c1>// 做一些收尾工作，例如心跳机制等
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=c1>// .....
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>接下来我们来单独分析下 <em><strong><code>serverHandler{c.server}.ServeHTTP(w, w.req)</code></strong></em> 是如何工作的</p><ol><li>前半部分***<code>serverHandler{c.server}.</code>*** 其实是创建了一个临时对象，这个对象有个成员是一个指向Server 的指针，事实上，c.server 就是我们在 main 函数中初始化的那个 server 对象，在监听套接字 accept 到新连接时，会创建一个 conn 连接对象，每个 conn 对象都会获取main 函数中建立的 server 的指针作为自己的一个数据成员，所以这个 <code>c.server</code> 其实就是我们main 函数中穿件的 server</li><li>后半部分，这个临时对象调用一个叫做 <em><strong><code>ServeHTTP(w, w.req)</code></strong></em> 的方法，传入参数为我们上面解析出来的 request 和 response</li></ol><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>type</span> <span class=nx>serverHandler</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>srv</span> <span class=o>*</span><span class=nx>Server</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>type</span> <span class=nx>conn</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=c1>// server is the server on which the connection arrived.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// Immutable; never nil.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>server</span> <span class=o>*</span><span class=nx>Server</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// cancelCtx cancels the connection-level context.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>cancelCtx</span> <span class=nx>context</span><span class=p>.</span><span class=nx>CancelFunc</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// rwc is the underlying network connection.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// This is never wrapped by other types and is the value given out
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// to CloseNotifier callers. It is usually of type *net.TCPConn or
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// *tls.Conn.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>rwc</span> <span class=nx>net</span><span class=p>.</span><span class=nx>Conn</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// remoteAddr is rwc.RemoteAddr().String(). It is not populated synchronously
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// inside the Listener&#39;s Accept goroutine, as some implementations block.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// It is populated immediately inside the (*conn).serve goroutine.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// This is the value of a Handler&#39;s (*Request).RemoteAddr.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>remoteAddr</span> <span class=kt>string</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// tlsState is the TLS connection state when using TLS.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// nil means not TLS.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>tlsState</span> <span class=o>*</span><span class=nx>tls</span><span class=p>.</span><span class=nx>ConnectionState</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// werr is set to the first write error to rwc.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// It is set via checkConnErrorWriter{w}, where bufw writes.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>werr</span> <span class=kt>error</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// r is bufr&#39;s read source. It&#39;s a wrapper around rwc that provides
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// io.LimitedReader-style limiting (while reading request headers)
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// and functionality to support CloseNotifier. See *connReader docs.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>r</span> <span class=o>*</span><span class=nx>connReader</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// bufr reads from r.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>bufr</span> <span class=o>*</span><span class=nx>bufio</span><span class=p>.</span><span class=nx>Reader</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// bufw writes to checkConnErrorWriter{c}, which populates werr on error.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>bufw</span> <span class=o>*</span><span class=nx>bufio</span><span class=p>.</span><span class=nx>Writer</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// lastMethod is the method of the most recent request
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// on this connection, if any.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>lastMethod</span> <span class=kt>string</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>curReq</span> <span class=nx>atomic</span><span class=p>.</span><span class=nx>Pointer</span><span class=p>[</span><span class=nx>response</span><span class=p>]</span> <span class=c1>// (which has a Request in it)
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>	<span class=nx>curState</span> <span class=nx>atomic</span><span class=p>.</span><span class=nx>Uint64</span> <span class=c1>// packed (unixtime&lt;&lt;8|uint8(ConnState))
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>	<span class=c1>// mu guards hijackedv
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>mu</span> <span class=nx>sync</span><span class=p>.</span><span class=nx>Mutex</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// hijackedv is whether this connection has been hijacked
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// by a Handler with the Hijacker interface.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// It is guarded by mu.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>hijackedv</span> <span class=kt>bool</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>接下来看看 <em><strong><code>serverHandler{c.server}.ServeHTTP(w, w.req)</code></strong></em> 具体的做了什么</p><ol><li>第一行获取 main 函数中创建的 server ，将这个server 的 handler 对象，也就是 router 路由引擎单独拿出来</li><li>最后一行，执行 router 路由引擎中的 <code>ServeHTTP(rw, req)</code> 函数</li></ol><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl>	<span class=c1>//  main()
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>//			router := routers.NewRouter()
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>//			s := &amp;http.Server{
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>//				Addr:           &#34;:&#34; + global.ServerSetting.HttpPort,
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>//				Handler:        router,
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>//				ReadTimeout:    global.ServerSetting.ReadTimeout,
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>//				WriteTimeout:   global.ServerSetting.WriteTimeout,
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>//				MaxHeaderBytes: 1 &lt;&lt; 20,
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>//			}
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>sh</span> <span class=nx>serverHandler</span><span class=p>)</span> <span class=nf>ServeHTTP</span><span class=p>(</span><span class=nx>rw</span> <span class=nx>ResponseWriter</span><span class=p>,</span> <span class=nx>req</span> <span class=o>*</span><span class=nx>Request</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// 获取 main 函数中创建的 server ，将这个server 的 handler 对象，也就是 router 路由引擎单独拿出来
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>handler</span> <span class=o>:=</span> <span class=nx>sh</span><span class=p>.</span><span class=nx>srv</span><span class=p>.</span><span class=nx>Handler</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>handler</span> <span class=o>==</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>handler</span> <span class=p>=</span> <span class=nx>DefaultServeMux</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=p>!</span><span class=nx>sh</span><span class=p>.</span><span class=nx>srv</span><span class=p>.</span><span class=nx>DisableGeneralOptionsHandler</span> <span class=o>&amp;&amp;</span> <span class=nx>req</span><span class=p>.</span><span class=nx>RequestURI</span> <span class=o>==</span> <span class=s>&#34;*&#34;</span> <span class=o>&amp;&amp;</span> <span class=nx>req</span><span class=p>.</span><span class=nx>Method</span> <span class=o>==</span> <span class=s>&#34;OPTIONS&#34;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>handler</span> <span class=p>=</span> <span class=nx>globalOptionsHandler</span><span class=p>{}</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>req</span><span class=p>.</span><span class=nx>URL</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=o>&amp;&amp;</span> <span class=nx>strings</span><span class=p>.</span><span class=nf>Contains</span><span class=p>(</span><span class=nx>req</span><span class=p>.</span><span class=nx>URL</span><span class=p>.</span><span class=nx>RawQuery</span><span class=p>,</span> <span class=s>&#34;;&#34;</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=kd>var</span> <span class=nx>allowQuerySemicolonsInUse</span> <span class=nx>atomic</span><span class=p>.</span><span class=nx>Bool</span>
</span></span><span class=line><span class=cl>		<span class=nx>req</span> <span class=p>=</span> <span class=nx>req</span><span class=p>.</span><span class=nf>WithContext</span><span class=p>(</span><span class=nx>context</span><span class=p>.</span><span class=nf>WithValue</span><span class=p>(</span><span class=nx>req</span><span class=p>.</span><span class=nf>Context</span><span class=p>(),</span> <span class=nx>silenceSemWarnContextKey</span><span class=p>,</span> <span class=kd>func</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nx>allowQuerySemicolonsInUse</span><span class=p>.</span><span class=nf>Store</span><span class=p>(</span><span class=kc>true</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=p>}))</span>
</span></span><span class=line><span class=cl>		<span class=k>defer</span> <span class=kd>func</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=k>if</span> <span class=p>!</span><span class=nx>allowQuerySemicolonsInUse</span><span class=p>.</span><span class=nf>Load</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=nx>sh</span><span class=p>.</span><span class=nx>srv</span><span class=p>.</span><span class=nf>logf</span><span class=p>(</span><span class=s>&#34;http: URL query contains semicolon, which is no longer a supported separator; parts of the query may be stripped when parsed; see golang.org/issue/25192&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=p>}()</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>handler</span><span class=p>.</span><span class=nf>ServeHTTP</span><span class=p>(</span><span class=nx>rw</span><span class=p>,</span> <span class=nx>req</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>接着我们砖到 router 路由引擎对象 的 engin 类， 我们接着看<br><em><strong><code>func (engine *Engine) ServeHTTP(w http.ResponseWriter, req *http.Request)</code></strong></em> 做了什么</p><ol><li>从 Context 内存池中获取一快内存</li><li>把 req 和 responseWriter 塞到 Context 里面</li><li>调用 <code>***engine.handleHTTPRequest(c)</code>*** 函数，这个函数会根据 http 请求头里的 method 和 path在 radix tree （前缀树，一个method 代表一个树的跟节点）中找到对应的节点 node， 节点 node 上挂载着用户在注册路由时同时注册进来的处理方法 handler</li><li>执行当前请求的路由上注册的对应handler，是一个回调函数，由用户提前注册好</li><li>用户注册的业务逻辑执行完成后，会向responseWrite 缓冲区写入数据，响应返回给客户端</li></ol><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>type</span> <span class=nx>Engine</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>RouterGroup</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// Enables automatic redirection if the current route can&#39;t be matched but a
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// handler for the path with (without) the trailing slash exists.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// For example if /foo/ is requested but a route only exists for /foo, the
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// client is redirected to /foo with http status code 301 for GET requests
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// and 307 for all other request methods.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>RedirectTrailingSlash</span> <span class=kt>bool</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// If enabled, the router tries to fix the current request path, if no
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// handle is registered for it.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// First superfluous path elements like ../ or // are removed.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// Afterwards the router does a case-insensitive lookup of the cleaned path.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// If a handle can be found for this route, the router makes a redirection
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// to the corrected path with status code 301 for GET requests and 307 for
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// all other request methods.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// For example /FOO and /..//Foo could be redirected to /foo.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// RedirectTrailingSlash is independent of this option.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>RedirectFixedPath</span> <span class=kt>bool</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// If enabled, the router checks if another method is allowed for the
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// current route, if the current request can not be routed.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// If this is the case, the request is answered with &#39;Method Not Allowed&#39;
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// and HTTP status code 405.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// If no other Method is allowed, the request is delegated to the NotFound
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// handler.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>HandleMethodNotAllowed</span> <span class=kt>bool</span>
</span></span><span class=line><span class=cl>	<span class=nx>ForwardedByClientIP</span>    <span class=kt>bool</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// #726 #755 If enabled, it will thrust some headers starting with
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// &#39;X-AppEngine...&#39; for better integration with that PaaS.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>AppEngine</span> <span class=kt>bool</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// If enabled, the url.RawPath will be used to find parameters.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>UseRawPath</span> <span class=kt>bool</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// If true, the path value will be unescaped.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// If UseRawPath is false (by default), the UnescapePathValues effectively is true,
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// as url.Path gonna be used, which is already unescaped.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>UnescapePathValues</span> <span class=kt>bool</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// Value of &#39;maxMemory&#39; param that is given to http.Request&#39;s ParseMultipartForm
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// method call.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>MaxMultipartMemory</span> <span class=kt>int64</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// RemoveExtraSlash a parameter can be parsed from the URL even with extra slashes.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// See the PR #1817 and issue #1644
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>RemoveExtraSlash</span> <span class=kt>bool</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>delims</span>           <span class=nx>render</span><span class=p>.</span><span class=nx>Delims</span>
</span></span><span class=line><span class=cl>	<span class=nx>secureJsonPrefix</span> <span class=kt>string</span>
</span></span><span class=line><span class=cl>	<span class=nx>HTMLRender</span>       <span class=nx>render</span><span class=p>.</span><span class=nx>HTMLRender</span>
</span></span><span class=line><span class=cl>	<span class=nx>FuncMap</span>          <span class=nx>template</span><span class=p>.</span><span class=nx>FuncMap</span>
</span></span><span class=line><span class=cl>	<span class=nx>allNoRoute</span>       <span class=nx>HandlersChain</span>
</span></span><span class=line><span class=cl>	<span class=nx>allNoMethod</span>      <span class=nx>HandlersChain</span>
</span></span><span class=line><span class=cl>	<span class=nx>noRoute</span>          <span class=nx>HandlersChain</span>
</span></span><span class=line><span class=cl>	<span class=nx>noMethod</span>         <span class=nx>HandlersChain</span>
</span></span><span class=line><span class=cl>	<span class=nx>pool</span>             <span class=nx>sync</span><span class=p>.</span><span class=nx>Pool</span>
</span></span><span class=line><span class=cl>	<span class=nx>trees</span>            <span class=nx>methodTrees</span>   <span class=c1>// 前缀树
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// ServeHTTP conforms to the http.Handler interface.
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>func</span> <span class=p>(</span><span class=nx>engine</span> <span class=o>*</span><span class=nx>Engine</span><span class=p>)</span> <span class=nf>ServeHTTP</span><span class=p>(</span><span class=nx>w</span> <span class=nx>http</span><span class=p>.</span><span class=nx>ResponseWriter</span><span class=p>,</span> <span class=nx>req</span> <span class=o>*</span><span class=nx>http</span><span class=p>.</span><span class=nx>Request</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>c</span> <span class=o>:=</span> <span class=nx>engine</span><span class=p>.</span><span class=nx>pool</span><span class=p>.</span><span class=nf>Get</span><span class=p>().(</span><span class=o>*</span><span class=nx>Context</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=nx>c</span><span class=p>.</span><span class=nx>writermem</span><span class=p>.</span><span class=nf>reset</span><span class=p>(</span><span class=nx>w</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=nx>c</span><span class=p>.</span><span class=nx>Request</span> <span class=p>=</span> <span class=nx>req</span>
</span></span><span class=line><span class=cl>	<span class=nx>c</span><span class=p>.</span><span class=nf>reset</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>engine</span><span class=p>.</span><span class=nf>handleHTTPRequest</span><span class=p>(</span><span class=nx>c</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>engine</span><span class=p>.</span><span class=nx>pool</span><span class=p>.</span><span class=nf>Put</span><span class=p>(</span><span class=nx>c</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>engine</span> <span class=o>*</span><span class=nx>Engine</span><span class=p>)</span> <span class=nf>handleHTTPRequest</span><span class=p>(</span><span class=nx>c</span> <span class=o>*</span><span class=nx>Context</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>httpMethod</span> <span class=o>:=</span> <span class=nx>c</span><span class=p>.</span><span class=nx>Request</span><span class=p>.</span><span class=nx>Method</span>
</span></span><span class=line><span class=cl>	<span class=nx>rPath</span> <span class=o>:=</span> <span class=nx>c</span><span class=p>.</span><span class=nx>Request</span><span class=p>.</span><span class=nx>URL</span><span class=p>.</span><span class=nx>Path</span>
</span></span><span class=line><span class=cl>	<span class=nx>unescape</span> <span class=o>:=</span> <span class=kc>false</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>engine</span><span class=p>.</span><span class=nx>UseRawPath</span> <span class=o>&amp;&amp;</span> <span class=nb>len</span><span class=p>(</span><span class=nx>c</span><span class=p>.</span><span class=nx>Request</span><span class=p>.</span><span class=nx>URL</span><span class=p>.</span><span class=nx>RawPath</span><span class=p>)</span> <span class=p>&gt;</span> <span class=mi>0</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>rPath</span> <span class=p>=</span> <span class=nx>c</span><span class=p>.</span><span class=nx>Request</span><span class=p>.</span><span class=nx>URL</span><span class=p>.</span><span class=nx>RawPath</span>
</span></span><span class=line><span class=cl>		<span class=nx>unescape</span> <span class=p>=</span> <span class=nx>engine</span><span class=p>.</span><span class=nx>UnescapePathValues</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>engine</span><span class=p>.</span><span class=nx>RemoveExtraSlash</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>rPath</span> <span class=p>=</span> <span class=nf>cleanPath</span><span class=p>(</span><span class=nx>rPath</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// Find root of the tree for the given HTTP method
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>t</span> <span class=o>:=</span> <span class=nx>engine</span><span class=p>.</span><span class=nx>trees</span>
</span></span><span class=line><span class=cl>	<span class=k>for</span> <span class=nx>i</span><span class=p>,</span> <span class=nx>tl</span> <span class=o>:=</span> <span class=mi>0</span><span class=p>,</span> <span class=nb>len</span><span class=p>(</span><span class=nx>t</span><span class=p>);</span> <span class=nx>i</span> <span class=p>&lt;</span> <span class=nx>tl</span><span class=p>;</span> <span class=nx>i</span><span class=o>++</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=nx>t</span><span class=p>[</span><span class=nx>i</span><span class=p>].</span><span class=nx>method</span> <span class=o>!=</span> <span class=nx>httpMethod</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=k>continue</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=nx>root</span> <span class=o>:=</span> <span class=nx>t</span><span class=p>[</span><span class=nx>i</span><span class=p>].</span><span class=nx>root</span>
</span></span><span class=line><span class=cl>		<span class=c1>// Find route in tree
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=nx>value</span> <span class=o>:=</span> <span class=nx>root</span><span class=p>.</span><span class=nf>getValue</span><span class=p>(</span><span class=nx>rPath</span><span class=p>,</span> <span class=nx>c</span><span class=p>.</span><span class=nx>Params</span><span class=p>,</span> <span class=nx>unescape</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=nx>value</span><span class=p>.</span><span class=nx>handlers</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nx>c</span><span class=p>.</span><span class=nx>handlers</span> <span class=p>=</span> <span class=nx>value</span><span class=p>.</span><span class=nx>handlers</span>
</span></span><span class=line><span class=cl>			<span class=nx>c</span><span class=p>.</span><span class=nx>Params</span> <span class=p>=</span> <span class=nx>value</span><span class=p>.</span><span class=nx>params</span>
</span></span><span class=line><span class=cl>			<span class=nx>c</span><span class=p>.</span><span class=nx>fullPath</span> <span class=p>=</span> <span class=nx>value</span><span class=p>.</span><span class=nx>fullPath</span>
</span></span><span class=line><span class=cl>			<span class=nx>c</span><span class=p>.</span><span class=nf>Next</span><span class=p>()</span>  <span class=c1>// 执行节点上用户注册的的路由的处理函数 handler 
</span></span></span><span class=line><span class=cl><span class=c1></span>			<span class=nx>c</span><span class=p>.</span><span class=nx>writermem</span><span class=p>.</span><span class=nf>WriteHeaderNow</span><span class=p>()</span>
</span></span><span class=line><span class=cl>			<span class=k>return</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=nx>httpMethod</span> <span class=o>!=</span> <span class=s>&#34;CONNECT&#34;</span> <span class=o>&amp;&amp;</span> <span class=nx>rPath</span> <span class=o>!=</span> <span class=s>&#34;/&#34;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=k>if</span> <span class=nx>value</span><span class=p>.</span><span class=nx>tsr</span> <span class=o>&amp;&amp;</span> <span class=nx>engine</span><span class=p>.</span><span class=nx>RedirectTrailingSlash</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=nf>redirectTrailingSlash</span><span class=p>(</span><span class=nx>c</span><span class=p>)</span>
</span></span><span class=line><span class=cl>				<span class=k>return</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span>
</span></span><span class=line><span class=cl>			<span class=k>if</span> <span class=nx>engine</span><span class=p>.</span><span class=nx>RedirectFixedPath</span> <span class=o>&amp;&amp;</span> <span class=nf>redirectFixedPath</span><span class=p>(</span><span class=nx>c</span><span class=p>,</span> <span class=nx>root</span><span class=p>,</span> <span class=nx>engine</span><span class=p>.</span><span class=nx>RedirectFixedPath</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=k>return</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=k>break</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>engine</span><span class=p>.</span><span class=nx>HandleMethodNotAllowed</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>for</span> <span class=nx>_</span><span class=p>,</span> <span class=nx>tree</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>engine</span><span class=p>.</span><span class=nx>trees</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=k>if</span> <span class=nx>tree</span><span class=p>.</span><span class=nx>method</span> <span class=o>==</span> <span class=nx>httpMethod</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=k>continue</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span>
</span></span><span class=line><span class=cl>			<span class=k>if</span> <span class=nx>value</span> <span class=o>:=</span> <span class=nx>tree</span><span class=p>.</span><span class=nx>root</span><span class=p>.</span><span class=nf>getValue</span><span class=p>(</span><span class=nx>rPath</span><span class=p>,</span> <span class=kc>nil</span><span class=p>,</span> <span class=nx>unescape</span><span class=p>);</span> <span class=nx>value</span><span class=p>.</span><span class=nx>handlers</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=nx>c</span><span class=p>.</span><span class=nx>handlers</span> <span class=p>=</span> <span class=nx>engine</span><span class=p>.</span><span class=nx>allNoMethod</span>
</span></span><span class=line><span class=cl>				<span class=nf>serveError</span><span class=p>(</span><span class=nx>c</span><span class=p>,</span> <span class=nx>http</span><span class=p>.</span><span class=nx>StatusMethodNotAllowed</span><span class=p>,</span> <span class=nx>default405Body</span><span class=p>)</span>
</span></span><span class=line><span class=cl>				<span class=k>return</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=nx>c</span><span class=p>.</span><span class=nx>handlers</span> <span class=p>=</span> <span class=nx>engine</span><span class=p>.</span><span class=nx>allNoRoute</span>
</span></span><span class=line><span class=cl>	<span class=nf>serveError</span><span class=p>(</span><span class=nx>c</span><span class=p>,</span> <span class=nx>http</span><span class=p>.</span><span class=nx>StatusNotFound</span><span class=p>,</span> <span class=nx>default404Body</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// 迭代器，依次执行 handler
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>func</span> <span class=p>(</span><span class=nx>c</span> <span class=o>*</span><span class=nx>Context</span><span class=p>)</span> <span class=nf>Next</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>c</span><span class=p>.</span><span class=nx>index</span><span class=o>++</span>
</span></span><span class=line><span class=cl>	<span class=k>for</span> <span class=nx>c</span><span class=p>.</span><span class=nx>index</span> <span class=p>&lt;</span> <span class=nb>int8</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=nx>c</span><span class=p>.</span><span class=nx>handlers</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>c</span><span class=p>.</span><span class=nx>handlers</span><span class=p>[</span><span class=nx>c</span><span class=p>.</span><span class=nx>index</span><span class=p>](</span><span class=nx>c</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=nx>c</span><span class=p>.</span><span class=nx>index</span><span class=o>++</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>顺带看下前缀树</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=c1>// 树的根节点
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>type</span> <span class=nx>methodTree</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>method</span> <span class=kt>string</span>
</span></span><span class=line><span class=cl>	<span class=nx>root</span>   <span class=o>*</span><span class=nx>node</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// 树的节点
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>type</span> <span class=nx>nodeValue</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>handlers</span> <span class=nx>HandlersChain</span>
</span></span><span class=line><span class=cl>	<span class=nx>params</span>   <span class=nx>Params</span>
</span></span><span class=line><span class=cl>	<span class=nx>tsr</span>      <span class=kt>bool</span>
</span></span><span class=line><span class=cl>	<span class=nx>fullPath</span> <span class=kt>string</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div></div><footer class=post-footer><ul class=post-tags></ul><nav class=paginav><a class=next href=https://LinPr.github.io/posts/unix_system_call/><span class=title>Next »</span><br><span>Unix_System_Call</span></a></nav><ul class=share-buttons><li><a target=_blank rel="noopener noreferrer" aria-label="share Go_Http连接建立和处理 on x" href="https://x.com/intent/tweet/?text=Go_Http%e8%bf%9e%e6%8e%a5%e5%bb%ba%e7%ab%8b%e5%92%8c%e5%a4%84%e7%90%86&amp;url=https%3a%2f%2fLinPr.github.io%2fposts%2fgo_http%25E8%25BF%259E%25E6%258E%25A5%25E5%25BB%25BA%25E7%25AB%258B%25E5%2592%258C%25E5%25A4%2584%25E7%2590%2586%2f&amp;hashtags="><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M512 62.554V449.446C512 483.97 483.97 512 449.446 512H62.554C28.03 512 0 483.97.0 449.446V62.554C0 28.03 28.029.0 62.554.0H449.446C483.971.0 512 28.03 512 62.554zM269.951 190.75 182.567 75.216H56L207.216 272.95 63.9 436.783h61.366L235.9 310.383l96.667 126.4H456L298.367 228.367l134-153.151H371.033zM127.633 110h36.468l219.38 290.065H349.5z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Go_Http连接建立和处理 on linkedin" href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https%3a%2f%2fLinPr.github.io%2fposts%2fgo_http%25E8%25BF%259E%25E6%258E%25A5%25E5%25BB%25BA%25E7%25AB%258B%25E5%2592%258C%25E5%25A4%2584%25E7%2590%2586%2f&amp;title=Go_Http%e8%bf%9e%e6%8e%a5%e5%bb%ba%e7%ab%8b%e5%92%8c%e5%a4%84%e7%90%86&amp;summary=Go_Http%e8%bf%9e%e6%8e%a5%e5%bb%ba%e7%ab%8b%e5%92%8c%e5%a4%84%e7%90%86&amp;source=https%3a%2f%2fLinPr.github.io%2fposts%2fgo_http%25E8%25BF%259E%25E6%258E%25A5%25E5%25BB%25BA%25E7%25AB%258B%25E5%2592%258C%25E5%25A4%2584%25E7%2590%2586%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM160.461 423.278V197.561h-75.04v225.717h75.04zm270.539.0V293.839c0-69.333-37.018-101.586-86.381-101.586-39.804.0-57.634 21.891-67.617 37.266v-31.958h-75.021c.995 21.181.0 225.717.0 225.717h75.02V297.222c0-6.748.486-13.492 2.474-18.315 5.414-13.475 17.767-27.434 38.494-27.434 27.135.0 38.007 20.707 38.007 51.037v120.768H431zM123.448 88.722C97.774 88.722 81 105.601 81 127.724c0 21.658 16.264 39.002 41.455 39.002h.484c26.165.0 42.452-17.344 42.452-39.002-.485-22.092-16.241-38.954-41.943-39.002z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Go_Http连接建立和处理 on reddit" href="https://reddit.com/submit?url=https%3a%2f%2fLinPr.github.io%2fposts%2fgo_http%25E8%25BF%259E%25E6%258E%25A5%25E5%25BB%25BA%25E7%25AB%258B%25E5%2592%258C%25E5%25A4%2584%25E7%2590%2586%2f&title=Go_Http%e8%bf%9e%e6%8e%a5%e5%bb%ba%e7%ab%8b%e5%92%8c%e5%a4%84%e7%90%86"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM446 265.638c0-22.964-18.616-41.58-41.58-41.58-11.211.0-21.361 4.457-28.841 11.666-28.424-20.508-67.586-33.757-111.204-35.278l18.941-89.121 61.884 13.157c.756 15.734 13.642 28.29 29.56 28.29 16.407.0 29.706-13.299 29.706-29.701.0-16.403-13.299-29.702-29.706-29.702-11.666.0-21.657 6.792-26.515 16.578l-69.105-14.69c-1.922-.418-3.939-.042-5.585 1.036-1.658 1.073-2.811 2.761-3.224 4.686l-21.152 99.438c-44.258 1.228-84.046 14.494-112.837 35.232-7.468-7.164-17.589-11.591-28.757-11.591-22.965.0-41.585 18.616-41.585 41.58.0 16.896 10.095 31.41 24.568 37.918-.639 4.135-.99 8.328-.99 12.576.0 63.977 74.469 115.836 166.33 115.836s166.334-51.859 166.334-115.836c0-4.218-.347-8.387-.977-12.493 14.564-6.47 24.735-21.034 24.735-38.001zM326.526 373.831c-20.27 20.241-59.115 21.816-70.534 21.816-11.428.0-50.277-1.575-70.522-21.82-3.007-3.008-3.007-7.882.0-10.889 3.003-2.999 7.882-3.003 10.885.0 12.777 12.781 40.11 17.317 59.637 17.317 19.522.0 46.86-4.536 59.657-17.321 3.016-2.999 7.886-2.995 10.885.008 3.008 3.011 3.003 7.882-.008 10.889zm-5.23-48.781c-16.373.0-29.701-13.324-29.701-29.698.0-16.381 13.328-29.714 29.701-29.714 16.378.0 29.706 13.333 29.706 29.714.0 16.374-13.328 29.698-29.706 29.698zM160.91 295.348c0-16.381 13.328-29.71 29.714-29.71 16.369.0 29.689 13.329 29.689 29.71.0 16.373-13.32 29.693-29.689 29.693-16.386.0-29.714-13.32-29.714-29.693z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Go_Http连接建立和处理 on facebook" href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2fLinPr.github.io%2fposts%2fgo_http%25E8%25BF%259E%25E6%258E%25A5%25E5%25BB%25BA%25E7%25AB%258B%25E5%2592%258C%25E5%25A4%2584%25E7%2590%2586%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H342.978V319.085h66.6l12.672-82.621h-79.272v-53.617c0-22.603 11.073-44.636 46.58-44.636H425.6v-70.34s-32.71-5.582-63.982-5.582c-65.288.0-107.96 39.569-107.96 111.204v62.971h-72.573v82.621h72.573V512h-191.104c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Go_Http连接建立和处理 on whatsapp" href="https://api.whatsapp.com/send?text=Go_Http%e8%bf%9e%e6%8e%a5%e5%bb%ba%e7%ab%8b%e5%92%8c%e5%a4%84%e7%90%86%20-%20https%3a%2f%2fLinPr.github.io%2fposts%2fgo_http%25E8%25BF%259E%25E6%258E%25A5%25E5%25BB%25BA%25E7%25AB%258B%25E5%2592%258C%25E5%25A4%2584%25E7%2590%2586%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zm-58.673 127.703c-33.842-33.881-78.847-52.548-126.798-52.568-98.799.0-179.21 80.405-179.249 179.234-.013 31.593 8.241 62.428 23.927 89.612l-25.429 92.884 95.021-24.925c26.181 14.28 55.659 21.807 85.658 21.816h.074c98.789.0 179.206-80.413 179.247-179.243.018-47.895-18.61-92.93-52.451-126.81zM263.976 403.485h-.06c-26.734-.01-52.954-7.193-75.828-20.767l-5.441-3.229-56.386 14.792 15.05-54.977-3.542-5.637c-14.913-23.72-22.791-51.136-22.779-79.287.033-82.142 66.867-148.971 149.046-148.971 39.793.014 77.199 15.531 105.329 43.692 28.128 28.16 43.609 65.592 43.594 105.4-.034 82.149-66.866 148.983-148.983 148.984zm81.721-111.581c-4.479-2.242-26.499-13.075-30.604-14.571-4.105-1.495-7.091-2.241-10.077 2.241-2.986 4.483-11.569 14.572-14.182 17.562-2.612 2.988-5.225 3.364-9.703 1.12-4.479-2.241-18.91-6.97-36.017-22.23C231.8 264.15 222.81 249.484 220.198 245s-.279-6.908 1.963-9.14c2.016-2.007 4.48-5.232 6.719-7.847 2.24-2.615 2.986-4.484 4.479-7.472 1.493-2.99.747-5.604-.374-7.846-1.119-2.241-10.077-24.288-13.809-33.256-3.635-8.733-7.327-7.55-10.077-7.688-2.609-.13-5.598-.158-8.583-.158-2.986.0-7.839 1.121-11.944 5.604-4.105 4.484-15.675 15.32-15.675 37.364.0 22.046 16.048 43.342 18.287 46.332 2.24 2.99 31.582 48.227 76.511 67.627 10.685 4.615 19.028 7.371 25.533 9.434 10.728 3.41 20.492 2.929 28.209 1.775 8.605-1.285 26.499-10.833 30.231-21.295 3.732-10.464 3.732-19.431 2.612-21.298-1.119-1.869-4.105-2.99-8.583-5.232z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Go_Http连接建立和处理 on telegram" href="https://telegram.me/share/url?text=Go_Http%e8%bf%9e%e6%8e%a5%e5%bb%ba%e7%ab%8b%e5%92%8c%e5%a4%84%e7%90%86&amp;url=https%3a%2f%2fLinPr.github.io%2fposts%2fgo_http%25E8%25BF%259E%25E6%258E%25A5%25E5%25BB%25BA%25E7%25AB%258B%25E5%2592%258C%25E5%25A4%2584%25E7%2590%2586%2f"><svg viewBox="2 2 28 28" height="30" width="30" fill="currentcolor"><path d="M26.49 29.86H5.5a3.37 3.37.0 01-2.47-1 3.35 3.35.0 01-1-2.47V5.48A3.36 3.36.0 013 3 3.37 3.37.0 015.5 2h21A3.38 3.38.0 0129 3a3.36 3.36.0 011 2.46V26.37a3.35 3.35.0 01-1 2.47 3.38 3.38.0 01-2.51 1.02zm-5.38-6.71a.79.79.0 00.85-.66L24.73 9.24a.55.55.0 00-.18-.46.62.62.0 00-.41-.17q-.08.0-16.53 6.11a.59.59.0 00-.41.59.57.57.0 00.43.52l4 1.24 1.61 4.83a.62.62.0 00.63.43.56.56.0 00.4-.17L16.54 20l4.09 3A.9.9.0 0021.11 23.15zM13.8 20.71l-1.21-4q8.72-5.55 8.78-5.55c.15.0.23.0.23.16a.18.18.0 010 .06s-2.51 2.3-7.52 6.8z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Go_Http连接建立和处理 on ycombinator" href="https://news.ycombinator.com/submitlink?t=Go_Http%e8%bf%9e%e6%8e%a5%e5%bb%ba%e7%ab%8b%e5%92%8c%e5%a4%84%e7%90%86&u=https%3a%2f%2fLinPr.github.io%2fposts%2fgo_http%25E8%25BF%259E%25E6%258E%25A5%25E5%25BB%25BA%25E7%25AB%258B%25E5%2592%258C%25E5%25A4%2584%25E7%2590%2586%2f"><svg width="30" height="30" viewBox="0 0 512 512" fill="currentcolor" xmlns:inkscape="http://www.inkscape.org/namespaces/inkscape"><path d="M449.446.0C483.971.0 512 28.03 512 62.554V449.446C512 483.97 483.97 512 449.446 512H62.554C28.03 512 0 483.97.0 449.446V62.554C0 28.03 28.029.0 62.554.0H449.446zM183.8767 87.9921h-62.034L230.6673 292.4508V424.0079h50.6655V292.4508L390.1575 87.9921H328.1233L256 238.2489z"/></svg></a></li></ul></footer></article></main><footer class=footer><span>&copy; 2024 <a href=https://LinPr.github.io/>Mr.LinPr Hugo Site</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>